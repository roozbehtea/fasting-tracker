<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fasting Streak</title>
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --accent: #f59e0b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --text: #1e1b4b; --text-muted: #6b7280;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            --gradient-3: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--gradient-1); min-height: 100vh; color: var(--text); }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }

        /* Auth */
        .auth-container { max-width: 450px; margin: 50px auto; }
        .auth-card { background: white; border-radius: 24px; padding: 48px 40px; box-shadow: 0 25px 80px rgba(0,0,0,0.25); }
        .auth-logo { text-align: center; font-size: 4em; margin-bottom: 8px; }
        .auth-title { text-align: center; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2.2em; font-weight: 700; margin-bottom: 8px; }
        .auth-subtitle { text-align: center; color: var(--text-muted); margin-bottom: 32px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--primary-dark); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 1em; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99,102,241,0.15); }
        .auth-buttons { display: flex; flex-direction: column; gap: 12px; margin-top: 24px; }
        .btn-auth { padding: 16px; border: none; border-radius: 12px; font-size: 1.05em; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--gradient-1); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(99,102,241,0.5); }
        .auth-switch { text-align: center; margin-top: 24px; color: var(--text-muted); }
        .auth-switch a { color: var(--primary); text-decoration: none; font-weight: 600; }

        /* Header */
        .header { background: white; border-radius: 20px; padding: 20px 28px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .header-title { display: flex; align-items: center; gap: 16px; }
        .header-title h1 { background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8em; font-weight: 700; }
        .cloud-sync-badge { background: var(--success); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        .cloud-sync-badge.syncing { background: var(--warning); }
        .user-info { display: flex; align-items: center; gap: 16px; }
        .user-email { color: var(--text-muted); font-weight: 500; }
        .btn-logout { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; }

        /* Dashboard */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .card { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
        .card-title { font-size: 1.2em; font-weight: 700; color: var(--primary-dark); margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }

        /* Water */
        .water-tracker { text-align: center; }
        .water-goal { font-family: monospace; font-size: 3.5em; font-weight: 700; background: linear-gradient(135deg, #2196F3, #03A9F4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 12px 0; }
        .water-goal-label { color: var(--text-muted); margin-bottom: 16px; }
        .water-progress { background: #e5e7eb; height: 24px; border-radius: 12px; overflow: hidden; margin: 16px 0; }
        .water-progress-fill { background: linear-gradient(90deg, #2196F3, #03A9F4); height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; min-width: 40px; transition: width 0.5s; }
        .water-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
        .btn-water { padding: 14px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #2196F3, #03A9F4); color: white; }
        .btn-water:hover { transform: translateY(-2px); }

        /* Tea */
        .tea-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 16px; }
        .tea-button { padding: 12px 8px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; text-align: center; }
        .tea-button:hover { border-color: var(--success); transform: translateY(-2px); }
        .tea-button .tea-icon { font-size: 1.8em; }
        .tea-button .tea-name { font-weight: 600; font-size: 0.85em; }
        .tea-button .tea-benefit { font-size: 0.7em; color: var(--text-muted); }
        .tea-today { margin-top: 16px; padding: 14px; background: rgba(16,185,129,0.1); border-radius: 12px; }
        .tea-today-title { font-weight: 700; color: var(--success); margin-bottom: 10px; }
        .tea-log-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }

        /* Streaks Card */
        .streaks-card { background: var(--gradient-1); color: white; }
        .streaks-card .card-title { color: white; }
        .streak-display { text-align: center; margin: 24px 0; }
        .streak-number { font-family: monospace; font-size: 5em; font-weight: 700; text-shadow: 0 4px 20px rgba(0,0,0,0.3); line-height: 1; }
        .streak-label { font-size: 1.2em; opacity: 0.9; margin-top: 8px; }
        .streak-types-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 20px; }
        .streak-type-card { background: rgba(255,255,255,0.15); padding: 14px 10px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2); }
        .streak-type-card.active { background: rgba(245,158,11,0.3); border-color: var(--accent); box-shadow: 0 0 20px rgba(245,158,11,0.3); }
        .streak-type-icon { font-size: 1.6em; }
        .streak-type-value { font-family: monospace; font-size: 1.5em; font-weight: 700; }
        .streak-type-label { font-size: 0.75em; opacity: 0.85; }

        /* Achievements */
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 10px; margin-top: 16px; }
        .achievement { background: rgba(255,255,255,0.15); padding: 12px 8px; border-radius: 12px; text-align: center; cursor: pointer; }
        .achievement.locked { opacity: 0.35; filter: grayscale(80%); }
        .achievement:not(.locked):hover { transform: translateY(-4px); background: rgba(255,255,255,0.25); }
        .achievement-icon { font-size: 2em; }
        .achievement-name { font-size: 0.7em; font-weight: 700; }
        .achievement-desc { font-size: 0.6em; opacity: 0.8; }

        /* Timer */
        .timer-display { text-align: center; font-family: monospace; font-size: 3.5em; font-weight: 700; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 24px 0; }
        .metabolic-zone { text-align: center; padding: 16px; margin: 16px 0; border-radius: 14px; font-weight: 600; }
        .zone-anabolic { background: #e3f2fd; color: #1565c0; }
        .zone-catabolic { background: #fff3e0; color: #e65100; }
        .zone-fat-burning { background: #e8f5e9; color: #2e7d32; }
        .zone-ketosis { background: #f3e5f5; color: #7b1fa2; }
        .zone-deep-ketosis { background: #fce4ec; color: #c2185b; }
        .zone-autophagy { background: #e0f2f1; color: #00695c; }
        .timer-stats { text-align: center; color: var(--text-muted); margin-bottom: 16px; }
        .timer-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .btn { padding: 16px; border: none; border-radius: 14px; font-size: 1.05em; font-weight: 600; cursor: pointer; }
        .btn-start { background: var(--gradient-3); color: white; }
        .btn-stop { background: var(--gradient-2); color: white; }
        .btn-cancel { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn:hover { transform: translateY(-2px); }

        /* Journal */
        .journal-section { margin-top: 20px; }
        .journal-prompts { background: rgba(99,102,241,0.08); border-radius: 14px; padding: 16px; margin-bottom: 16px; }
        .journal-prompt-title { font-weight: 700; color: var(--primary); margin-bottom: 12px; }
        .journal-prompt-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .journal-prompt-checkbox { width: 22px; height: 22px; border: 2px solid var(--primary); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .journal-prompt-checkbox.checked { background: var(--primary); color: white; }
        .journal-prompt-text { flex: 1; font-size: 0.95em; }
        .journal-prompt-text.completed { text-decoration: line-through; opacity: 0.6; }
        .journal-textarea { width: 100%; min-height: 100px; padding: 14px; border: 2px solid #e5e7eb; border-radius: 14px; font-family: inherit; resize: vertical; }

        /* Activity */
        .activity-section { margin-top: 20px; }
        .activity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); gap: 8px; }
        .activity-btn { padding: 12px 8px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; text-align: center; }
        .activity-btn:hover { border-color: var(--primary); transform: translateY(-2px); }
        .activity-btn.logged { border-color: var(--success); background: rgba(16,185,129,0.1); }
        .activity-btn .activity-icon { font-size: 1.6em; }
        .activity-btn .activity-name { font-size: 0.8em; font-weight: 600; }
        .activity-log { margin-top: 16px; padding: 14px; background: rgba(16,185,129,0.1); border-radius: 12px; }
        .activity-log-title { font-weight: 700; color: var(--primary); margin-bottom: 10px; }
        .activity-log-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }

        /* Weight */
        .weight-chart-container { background: rgba(99,102,241,0.05); border-radius: 14px; padding: 20px; margin-top: 16px; }
        .weight-chart { height: 160px; display: flex; align-items: flex-end; justify-content: space-around; padding: 20px 10px 30px; border-bottom: 2px solid #e5e7eb; border-left: 2px solid #e5e7eb; }
        .weight-bar { width: 30px; background: var(--gradient-1); border-radius: 6px 6px 0 0; position: relative; }
        .weight-bar-label { position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%); font-size: 0.65em; color: var(--text-muted); font-weight: 600; }
        .weight-bar-value { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 0.7em; font-weight: 700; color: var(--primary-dark); }
        .weight-input-row { display: flex; gap: 12px; margin-top: 16px; }
        .weight-input-row input { flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; }
        .weight-loss-badge { display: inline-flex; align-items: center; gap: 8px; background: var(--gradient-3); color: white; padding: 10px 16px; border-radius: 20px; font-weight: 700; margin-top: 16px; }
        .weight-milestones { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }
        .weight-milestone { background: rgba(16,185,129,0.1); border: 2px solid rgba(16,185,129,0.3); padding: 8px 12px; border-radius: 10px; text-align: center; }
        .weight-milestone.achieved { background: var(--success); border-color: var(--success); color: white; }
        .weight-milestone.next { border-color: var(--accent); animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(245,158,11,0.4); } 50% { box-shadow: 0 0 0 8px rgba(245,158,11,0); } }
        .weight-milestone-value { font-family: monospace; font-size: 1.1em; font-weight: 700; }
        .weight-milestone-label { font-size: 0.65em; opacity: 0.8; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 12px; }
        .stat-box { text-align: center; padding: 16px 10px; background: #f8fafc; border-radius: 12px; }
        .stat-value { font-family: monospace; font-size: 1.5em; font-weight: 700; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-label { font-size: 0.8em; color: var(--text-muted); margin-top: 4px; }

        /* History */
        .history-card { margin-top: 24px; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        .history-table th { background: var(--gradient-1); color: white; padding: 12px 10px; text-align: left; font-size: 0.85em; }
        .history-table th:first-child { border-radius: 10px 0 0 0; }
        .history-table th:last-child { border-radius: 0 10px 0 0; }
        .history-table td { padding: 12px 10px; border-bottom: 1px solid #e5e7eb; font-size: 0.9em; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,14,42,0.7); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 24px; padding: 32px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-title { font-size: 1.5em; font-weight: 700; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .modal-close { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #9ca3af; }

        /* Toast */
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--success); color: white; padding: 16px 24px; border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); z-index: 2000; animation: slideIn 0.4s; font-weight: 600; }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .header { flex-direction: column; text-align: center; }
            .streak-types-grid { grid-template-columns: repeat(2, 1fr); }
            .timer-display { font-size: 2.5em; }
            .streak-number { font-size: 3.5em; }
        }
        .water-date { font-size: 0.85em; color: var(--text-muted); margin-bottom: 12px; }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">üî•</div>
            <h1 class="auth-title">Fasting Streak</h1>
            <p class="auth-subtitle">Track streaks, build habits, transform your health</p>
            <div id="loginForm">
                <div class="form-group"><label>Email</label><input type="email" id="loginEmail" placeholder="your@email.com"></div>
                <div class="form-group"><label>Password</label><input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <div class="auth-buttons"><button class="btn-auth btn-primary" onclick="login()">Login</button></div>
                <div class="auth-switch">Don't have an account? <a href="#" onclick="showSignup(); return false;">Sign up</a></div>
            </div>
            <div id="signupForm" class="hidden">
                <div class="form-group"><label>Email</label><input type="email" id="signupEmail" placeholder="your@email.com"></div>
                <div class="form-group"><label>Password</label><input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <div class="form-group"><label>Confirm Password</label><input type="password" id="signupPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <div class="auth-buttons"><button class="btn-auth btn-primary" onclick="signup()">Create Account</button></div>
                <div class="auth-switch">Already have an account? <a href="#" onclick="showLogin(); return false;">Login</a></div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appScreen" class="container hidden">
        <div class="header">
            <div class="header-title"><h1>üî• Fasting Streak</h1><div id="cloudSyncBadge" class="cloud-sync-badge">‚òÅÔ∏è Synced</div></div>
            <div class="user-info"><span class="user-email" id="userEmail"></span><button class="btn-logout" onclick="logout()">Logout</button></div>
        </div>

        <div class="dashboard">
            <!-- Timer Card -->
            <div class="card">
                <div class="card-title">‚è±Ô∏è Fasting Timer</div>
                <div id="timerDisplay" class="timer-display">00:00:00</div>
                <div id="metabolicZone" class="metabolic-zone zone-anabolic">üîµ Ready to Start</div>
                <div id="timerStats" class="timer-stats"></div>
                <div class="timer-controls">
                    <button id="startBtn" class="btn btn-start" onclick="startFast()">‚ñ∂ Start Fast</button>
                    <button id="stopBtn" class="btn btn-stop hidden" onclick="endFast()">‚èπ End Fast</button>
                    <button id="cancelBtn" class="btn btn-cancel hidden" onclick="cancelFast()">‚úñ Cancel</button>
                </div>
                <div style="margin-top: 16px;">
                    <label style="font-weight: 600; color: var(--primary-dark); display: block; margin-bottom: 8px;">Goal (hours):</label>
                    <input type="number" id="goalInput" value="16" min="1" max="72" style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #e5e7eb;">
                </div>
                <div class="journal-section">
                    <div class="journal-prompts"><div class="journal-prompt-title">üìù Check-in Prompts</div><div id="journalPromptsList"></div></div>
                    <textarea id="notesInput" class="journal-textarea" placeholder="Additional thoughts, observations, or reflections..."></textarea>
                </div>
                <div class="activity-section">
                    <div class="card-title" style="margin-top: 8px;">üèÉ Activities</div>
                    <div class="activity-grid" id="activityGrid"></div>
                    <div id="activityLog" class="activity-log hidden"><div class="activity-log-title">Today's Activities</div><div id="activityLogList"></div></div>
                </div>
            </div>

            <!-- Streaks Card -->
            <div class="card streaks-card">
                <div class="card-title">üî• Streaks & Achievements</div>
                <div class="streak-display"><div class="streak-number" id="currentStreak">0</div><div class="streak-label">Day Fasting Streak</div></div>
                <div class="streak-types-grid">
                    <div class="streak-type-card" id="streakFasting"><div class="streak-type-icon">‚è±Ô∏è</div><div class="streak-type-value" id="fastingStreakVal">0</div><div class="streak-type-label">Fasting</div></div>
                    <div class="streak-type-card" id="streakWater"><div class="streak-type-icon">üíß</div><div class="streak-type-value" id="waterStreakVal">0</div><div class="streak-type-label">Hydration</div></div>
                    <div class="streak-type-card" id="streakMeditation"><div class="streak-type-icon">üßò</div><div class="streak-type-value" id="meditationStreakVal">0</div><div class="streak-type-label">Meditation</div></div>
                    <div class="streak-type-card" id="streakExercise"><div class="streak-type-icon">üí™</div><div class="streak-type-value" id="exerciseStreakVal">0</div><div class="streak-type-label">Exercise</div></div>
                    <div class="streak-type-card" id="streakJournal"><div class="streak-type-icon">üìì</div><div class="streak-type-value" id="journalStreakVal">0</div><div class="streak-type-label">Journal</div></div>
                    <div class="streak-type-card" id="streakWeightLog"><div class="streak-type-icon">‚öñÔ∏è</div><div class="streak-type-value" id="weightLogStreakVal">0</div><div class="streak-type-label">Weight Log</div></div>
                    <div class="streak-type-card" id="streakPerfectDay"><div class="streak-type-icon">‚≠ê</div><div class="streak-type-value" id="perfectDayStreakVal">0</div><div class="streak-type-label">Perfect Days</div></div>
                </div>
                <div style="margin-top: 24px;"><div class="card-title" style="color: white;">üèÜ Achievements</div><div class="achievements-grid" id="achievementsGrid"></div></div>
            </div>

            <!-- Water Card -->
            <div class="card water-tracker">
                <div class="card-title">üíß Hydration</div>
                <div class="water-date" id="waterDate"></div>
                <div class="water-goal" id="waterCount">0</div>
                <div class="water-goal-label">of <span id="waterGoal">8</span> cups today</div>
                <div class="water-progress"><div class="water-progress-fill" id="waterProgressFill" style="width: 0%"><span id="waterPercent">0%</span></div></div>
                <div class="water-buttons"><button class="btn-water" onclick="addWater(1)">üíß +1 Cup</button><button class="btn-water" onclick="addWater(-1)">‚ûñ -1 Cup</button></div>
                <button class="btn-water" onclick="showTeaModal()" style="margin-top: 12px; width: 100%;">üçµ Log Tea</button>
                <div id="teaToday" class="tea-today hidden"><div class="tea-today-title">‚òï Today's Teas</div><div id="teaTodayList"></div></div>
            </div>

            <!-- Weight Card -->
            <div class="card">
                <div class="card-title">‚öñÔ∏è Weight Tracking</div>
                <div class="stats-grid" style="margin-bottom: 16px;">
                    <div class="stat-box"><div class="stat-value" id="currentWeight">‚Äî</div><div class="stat-label">Current</div></div>
                    <div class="stat-box"><div class="stat-value" id="startingWeight">‚Äî</div><div class="stat-label">Starting</div></div>
                    <div class="stat-box"><div class="stat-value" id="weightLost">‚Äî</div><div class="stat-label">Lost</div></div>
                </div>
                <div id="weightLossBadge" class="weight-loss-badge hidden">üéâ <span id="weightLossAmount">0</span> lbs lost!</div>
                <div class="weight-milestones" id="weightMilestones"></div>
                <div class="weight-chart-container"><div style="font-weight: 600; color: var(--primary-dark); margin-bottom: 12px;">üìä Last 7 Days</div><div class="weight-chart" id="weightChart"></div></div>
                <div class="weight-input-row"><input type="number" id="weightInput" step="0.1" placeholder="Enter weight (lbs)"><button class="btn btn-start" onclick="logWeight()" style="white-space: nowrap;">üìù Log</button></div>
            </div>

            <!-- Stats Card -->
            <div class="card">
                <div class="card-title">üìä Statistics</div>
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-value" id="totalFasts">0</div><div class="stat-label">Total Fasts</div></div>
                    <div class="stat-box"><div class="stat-value" id="avgDuration">‚Äî</div><div class="stat-label">Avg Duration</div></div>
                    <div class="stat-box"><div class="stat-value" id="totalHours">‚Äî</div><div class="stat-label">Total Hours</div></div>
                    <div class="stat-box"><div class="stat-value" id="longestStreak">0</div><div class="stat-label">Best Streak</div></div>
                    <div class="stat-box"><div class="stat-value" id="waterAvg">‚Äî</div><div class="stat-label">Avg Hydration</div></div>
                    <div class="stat-box"><div class="stat-value" id="goalSuccess">‚Äî</div><div class="stat-label">Goal Success</div></div>
                </div>
                <button class="btn btn-start" onclick="showProfileModal()" style="width: 100%; margin-top: 16px; background: var(--gradient-1);">‚öôÔ∏è Edit Profile</button>
            </div>
        </div>

        <!-- History -->
        <div class="card history-card">
            <div class="card-title">üìú Fasting History</div>
            <button class="btn btn-start" onclick="exportToExcel()" style="margin-bottom: 16px; background: var(--gradient-3);">üì• Export to Excel</button>
            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead><tr><th>Date</th><th>Duration</th><th>Goal</th><th>Weight</th><th>üíß</th><th>Activities</th><th>Journal</th><th>Details</th></tr></thead>
                    <tbody id="historyTableBody"><tr><td colspan="8" style="text-align: center; color: #999;">No fasting history yet</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="teaModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">üçµ Select Tea</h2><button class="modal-close" onclick="closeTeaModal()">√ó</button></div><div class="tea-grid" id="teaGrid"></div></div></div>
    <div id="profileModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">üë§ Profile</h2><button class="modal-close" onclick="closeProfileModal()">√ó</button></div><div class="form-group"><label>Starting Weight (lbs)</label><input type="number" id="profileStartWeight" step="0.1"></div><div class="form-group"><label>Goal Weight (lbs)</label><input type="number" id="profileGoalWeight" step="0.1"></div><div class="form-group"><label>Daily Water Goal (cups)</label><input type="number" id="profileWaterGoal" min="1" max="30" value="8"></div>
        <div style="margin-top: 24px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
            <div style="font-weight: 700; color: var(--primary-dark); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">‚öôÔ∏è Custom Metabolic Zone Times (hours)</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group" style="margin-bottom: 12px;"><label style="font-size: 0.85em;">üîµ Catabolic starts at</label><input type="number" id="zoneCatabolic" min="1" max="72" value="4" style="padding: 10px;"></div>
                <div class="form-group" style="margin-bottom: 12px;"><label style="font-size: 0.85em;">üü¢ Fat Burning starts at</label><input type="number" id="zoneFatBurn" min="1" max="72" value="8" style="padding: 10px;"></div>
                <div class="form-group" style="margin-bottom: 12px;"><label style="font-size: 0.85em;">üü£ Ketosis starts at</label><input type="number" id="zoneKetosis" min="1" max="72" value="12" style="padding: 10px;"></div>
                <div class="form-group" style="margin-bottom: 12px;"><label style="font-size: 0.85em;">üî¥ Deep Ketosis starts at</label><input type="number" id="zoneDeepKetosis" min="1" max="72" value="16" style="padding: 10px;"></div>
                <div class="form-group" style="margin-bottom: 12px;"><label style="font-size: 0.85em;">üß¨ Autophagy starts at</label><input type="number" id="zoneAutophagy" min="1" max="72" value="24" style="padding: 10px;"></div>
            </div>
            <p style="font-size: 0.8em; color: var(--text-muted); margin-top: 8px;">üí° Customize based on your metabolism. Default: 4, 8, 12, 16, 24 hours.</p>
        </div>
        <button class="btn btn-start" onclick="saveProfile()" style="width: 100%; margin-top: 20px; background: var(--gradient-1);">üíæ Save Profile</button></div></div>
    <div id="activityModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="activityModalTitle">üßò Log Activity</h2><button class="modal-close" onclick="closeActivityModal()">√ó</button></div><div class="form-group"><label>Duration (minutes)</label><input type="number" id="activityDuration" min="1" max="300" value="15"></div><div class="form-group"><label>Notes (optional)</label><textarea id="activityNotes" rows="3" placeholder="How did it go?"></textarea></div><button class="btn btn-start" onclick="confirmLogActivity()" style="width: 100%;">‚úì Log Activity</button></div></div>
    
    <div id="fastDetailModal" class="modal"><div class="modal-content" style="max-width: 700px;">
        <div class="modal-header"><h2 class="modal-title">üìä Fast Details</h2><button class="modal-close" onclick="closeFastDetailModal()">√ó</button></div>
        <div id="fastDetailContent"></div>
    </div></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase Config
        firebase.initializeApp({
            apiKey: "AIzaSyAD037fOI7q5D2zPoqmvrBj6CPYuv4DJoM",
            authDomain: "fasting-tracker-1b50c.firebaseapp.com",
            databaseURL: "https://fasting-tracker-1b50c-default-rtdb.firebaseio.com",
            projectId: "fasting-tracker-1b50c",
            storageBucket: "fasting-tracker-1b50c.firebasestorage.app",
            messagingSenderId: "268148990974",
            appId: "1:268148990974:web:ba96a44fc3b1ea50838f69"
        });
        const auth = firebase.auth();
        const database = firebase.database();

        // Data Definitions
        const TEA_LIBRARY = [
            { id: 'gynostemma', name: 'Gynostemma', icon: 'üçÉ', benefit: 'Blood sugar', hydration: 1.0 },
            { id: 'green', name: 'Green Tea', icon: 'üçµ', benefit: 'Metabolism', hydration: 0.9 },
            { id: 'ginger', name: 'Ginger', icon: 'ü´ö', benefit: 'Appetite', hydration: 1.0 },
            { id: 'chamomile', name: 'Chamomile', icon: 'üåº', benefit: 'Calming', hydration: 1.0 },
            { id: 'peppermint', name: 'Peppermint', icon: 'üåø', benefit: 'Digestive', hydration: 1.0 },
            { id: 'matcha', name: 'Matcha', icon: 'üçµ', benefit: 'Focus', hydration: 0.85 },
            { id: 'coffee', name: 'Coffee', icon: '‚òï', benefit: 'Energy', hydration: 0.7 },
            { id: 'custom', name: 'Custom', icon: '‚ú®', benefit: 'Your choice', hydration: 1.0, isCustom: true }
        ];

        const ACTIVITY_TYPES = [
            { id: 'meditation', name: 'Meditate', icon: 'üßò', category: 'mindfulness' },
            { id: 'yoga', name: 'Yoga', icon: 'üßé', category: 'exercise' },
            { id: 'walking', name: 'Walk', icon: 'üö∂', category: 'exercise' },
            { id: 'running', name: 'Run', icon: 'üèÉ', category: 'exercise' },
            { id: 'weights', name: 'Weights', icon: 'üèãÔ∏è', category: 'exercise' },
            { id: 'cycling', name: 'Cycle', icon: 'üö¥', category: 'exercise' },
            { id: 'breathing', name: 'Breathe', icon: 'üå¨Ô∏è', category: 'mindfulness' },
            { id: 'journaling', name: 'Journal', icon: 'üìì', category: 'mindfulness' }
        ];

        const JOURNAL_PROMPTS = {
            0: [{ id: 'intention', text: 'What is your intention for this fast?' }, { id: 'feeling', text: 'How are you feeling right now?' }],
            4: [{ id: 'hunger', text: 'Rate your hunger level (1-10)' }, { id: 'energy', text: 'How is your energy level?' }],
            8: [{ id: 'fatburn', text: 'Notice any signs of fat burning?' }, { id: 'cravings', text: 'Any cravings? What are they?' }],
            12: [{ id: 'ketosis', text: 'Signs of ketosis? (mental clarity, reduced hunger)' }, { id: 'physical', text: 'How does your body feel?' }],
            16: [{ id: 'clarity', text: 'Notice any mental clarity changes?' }, { id: 'accomplishment', text: 'You hit your goal! How does it feel?' }],
            24: [{ id: 'autophagy', text: 'Notice any deep cleansing sensations?' }, { id: 'reflection', text: 'What have you learned about yourself?' }]
        };

        const ACHIEVEMENTS = [
            { id: 'first', name: 'First Fast', icon: 'ü•á', desc: 'First fast', check: d => d.totalFasts >= 1 },
            { id: 's3', name: '3 Days', icon: 'üî•', desc: '3 day streak', check: d => d.fastingStreak >= 3 },
            { id: 's7', name: 'Week', icon: '‚ö°', desc: '7 day streak', check: d => d.fastingStreak >= 7 },
            { id: 's30', name: 'Month', icon: 'üëë', desc: '30 day streak', check: d => d.fastingStreak >= 30 },
            { id: 'k10', name: 'Ketosis', icon: 'üéØ', desc: 'Ketosis 10x', check: d => d.ketosisCount >= 10 },
            { id: 'h24', name: '24 Hours', icon: 'üß¨', desc: '24+ hour fast', check: d => d.longest24Plus },
            { id: 'h100', name: '100 Hours', icon: 'üèãÔ∏è', desc: '100 hours', check: d => d.totalHours >= 100 },
            { id: 'w5', name: '5 lbs', icon: 'üìâ', desc: 'Lost 5 lbs', check: d => d.weightLoss >= 5 },
            { id: 'w10', name: '10 lbs', icon: 'üî•', desc: 'Lost 10 lbs', check: d => d.weightLoss >= 10 },
            { id: 'w15', name: '15 lbs', icon: '‚ö°', desc: 'Lost 15 lbs', check: d => d.weightLoss >= 15 },
            { id: 'w20', name: '20 lbs', icon: 'üèÖ', desc: 'Lost 20 lbs', check: d => d.weightLoss >= 20 },
            { id: 'w25', name: '25 lbs', icon: 'üí™', desc: 'Lost 25 lbs', check: d => d.weightLoss >= 25 },
            { id: 'w30', name: '30 lbs', icon: 'üëë', desc: 'Lost 30 lbs', check: d => d.weightLoss >= 30 },
            { id: 'm7', name: 'Zen', icon: 'üßò', desc: '7d meditation', check: d => d.meditationStreak >= 7 },
            { id: 'e7', name: 'Fit', icon: 'üí™', desc: '7d exercise', check: d => d.exerciseStreak >= 7 },
            { id: 'wa7', name: 'Hydrated', icon: 'üíß', desc: '7d water goal', check: d => d.waterStreak >= 7 },
            { id: 'p7', name: 'Perfect', icon: '‚≠ê', desc: '7 perfect days', check: d => d.perfectDayStreak >= 7 }
        ];

        // Global State
        let currentUser = null, currentFast = null, timerInterval = null, selectedActivity = null;
        let dailyData = { water: 0, teas: [], activities: [], journalChecks: {}, date: '' };
        let customZones = { catabolic: 4, fatBurn: 8, ketosis: 12, deepKetosis: 16, autophagy: 24 };

        // Auth
        auth.onAuthStateChanged(async user => {
            if (user) { currentUser = user; showApp(); await loadUserData(); }
            else { currentUser = null; showAuth(); }
        });

        function showLogin() { document.getElementById('loginForm').classList.remove('hidden'); document.getElementById('signupForm').classList.add('hidden'); }
        function showSignup() { document.getElementById('loginForm').classList.add('hidden'); document.getElementById('signupForm').classList.remove('hidden'); }
        async function login() { try { await auth.signInWithEmailAndPassword(document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); } catch(e) { showToast(e.message, 'error'); } }
        async function signup() {
            const pw = document.getElementById('signupPassword').value;
            if (pw !== document.getElementById('signupPasswordConfirm').value) { showToast('Passwords do not match', 'error'); return; }
            if (pw.length < 6) { showToast('Password must be 6+ chars', 'error'); return; }
            try { const cred = await auth.createUserWithEmailAndPassword(document.getElementById('signupEmail').value, pw); await database.ref(`users/${cred.user.uid}/profile`).set({ waterGoal: 8, createdAt: Date.now() }); } catch(e) { showToast(e.message, 'error'); }
        }
        function logout() { auth.signOut(); }
        function showAuth() { document.getElementById('authScreen').classList.remove('hidden'); document.getElementById('appScreen').classList.add('hidden'); }
        function showApp() { document.getElementById('authScreen').classList.add('hidden'); document.getElementById('appScreen').classList.remove('hidden'); document.getElementById('userEmail').textContent = currentUser.email; }

        // Load Data
        async function loadUserData() {
            const uid = currentUser.uid;
            const profile = (await database.ref(`users/${uid}/profile`).once('value')).val() || { waterGoal: 8 };
            document.getElementById('waterGoal').textContent = profile.waterGoal || 8;
            if (profile.weight) document.getElementById('currentWeight').textContent = profile.weight + ' lbs';
            if (profile.startWeight) document.getElementById('startingWeight').textContent = profile.startWeight + ' lbs';
            // Load custom zones
            if (profile.zones) { customZones = { catabolic: profile.zones.catabolic || 4, fatBurn: profile.zones.fatBurn || 8, ketosis: profile.zones.ketosis || 12, deepKetosis: profile.zones.deepKetosis || 16, autophagy: profile.zones.autophagy || 24 }; }
            currentFast = (await database.ref(`users/${uid}/currentFast`).once('value')).val();
            if (currentFast) { document.getElementById('startBtn').classList.add('hidden'); document.getElementById('stopBtn').classList.remove('hidden'); document.getElementById('cancelBtn').classList.remove('hidden'); document.getElementById('goalInput').value = currentFast.goal || 16; document.getElementById('notesInput').value = currentFast.notes || ''; startTimer(); }
            await loadDailyData(); await loadHistory(); await loadWeightHistory(); await calculateAllStreaks(); await updateAchievements();
            renderTeaGrid(); renderActivityGrid(); updateJournalPrompts();
        }

        async function loadDailyData() {
            const today = new Date().toISOString().split('T')[0];
            const data = (await database.ref(`users/${currentUser.uid}/daily/${today}`).once('value')).val();
            dailyData = data ? { water: data.water || 0, teas: data.teas || [], activities: data.activities || [], journalChecks: data.journalChecks || {}, date: today } : { water: 0, teas: [], activities: [], journalChecks: {}, date: today };
            updateWaterDisplay(); updateTeaTodayDisplay(); updateActivityLogDisplay();
            document.getElementById('waterDate').textContent = new Date(today + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }
        setInterval(() => { const today = new Date().toISOString().split('T')[0]; if (dailyData.date && dailyData.date !== today) { loadDailyData(); showToast('üåÖ New day!'); } }, 60000);
        async function saveDailyData() { setSyncBadge('syncing'); await database.ref(`users/${currentUser.uid}/daily/${dailyData.date}`).set(dailyData); setSyncBadge('synced'); }

        // Water
        async function addWater(amt) { dailyData.water = Math.max(0, dailyData.water + amt); updateWaterDisplay(); await saveDailyData(); if (amt > 0) showToast('üíß Water logged!'); }
        function updateWaterDisplay() { const goal = parseInt(document.getElementById('waterGoal').textContent) || 8; const pct = Math.min(100, (dailyData.water / goal) * 100); document.getElementById('waterCount').textContent = Math.round(dailyData.water * 10) / 10; document.getElementById('waterProgressFill').style.width = pct + '%'; document.getElementById('waterPercent').textContent = Math.round(pct) + '%'; }

        // Tea
        function renderTeaGrid() { const grid = document.getElementById('teaGrid'); grid.innerHTML = TEA_LIBRARY.map(tea => `<div class="tea-button" onclick="logTea('${tea.id}')"><div class="tea-icon">${tea.icon}</div><div class="tea-name">${tea.name}</div><div class="tea-benefit">${tea.benefit}</div></div>`).join(''); }
        function showTeaModal() { document.getElementById('teaModal').classList.add('show'); }
        function closeTeaModal() { document.getElementById('teaModal').classList.remove('show'); }
        async function logTea(teaId) { const tea = TEA_LIBRARY.find(t => t.id === teaId); let name = tea.name; if (tea.isCustom) { name = prompt('Enter tea name:'); if (!name) return; } dailyData.teas.push({ id: tea.id, name, icon: tea.icon, time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) }); dailyData.water += tea.hydration; updateWaterDisplay(); updateTeaTodayDisplay(); await saveDailyData(); closeTeaModal(); showToast(`üçµ ${name} logged!`); }
        function updateTeaTodayDisplay() { const container = document.getElementById('teaToday'); if (dailyData.teas.length === 0) { container.classList.add('hidden'); return; } container.classList.remove('hidden'); document.getElementById('teaTodayList').innerHTML = dailyData.teas.map(t => `<div class="tea-log-item"><span>${t.icon} ${t.name}</span><span>${t.time}</span></div>`).join(''); }

        // Activities
        function renderActivityGrid() { document.getElementById('activityGrid').innerHTML = ACTIVITY_TYPES.map(a => `<div class="activity-btn ${dailyData.activities.some(x => x.id === a.id) ? 'logged' : ''}" onclick="showActivityModal('${a.id}')"><div class="activity-icon">${a.icon}</div><div class="activity-name">${a.name}</div></div>`).join(''); }
        function showActivityModal(activityId) { selectedActivity = ACTIVITY_TYPES.find(a => a.id === activityId); document.getElementById('activityModalTitle').textContent = `${selectedActivity.icon} Log ${selectedActivity.name}`; document.getElementById('activityDuration').value = selectedActivity.category === 'mindfulness' ? 15 : 30; document.getElementById('activityNotes').value = ''; document.getElementById('activityModal').classList.add('show'); }
        function closeActivityModal() { document.getElementById('activityModal').classList.remove('show'); selectedActivity = null; }
        async function confirmLogActivity() { 
            if (!selectedActivity) return; 
            const duration = parseInt(document.getElementById('activityDuration').value) || 15; 
            const activityLog = { id: selectedActivity.id, name: selectedActivity.name, icon: selectedActivity.icon, category: selectedActivity.category, duration, time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }), timestamp: Date.now() };
            // Add fasting hour if currently fasting
            if (currentFast) {
                activityLog.fastingHour = Math.floor((Date.now() - currentFast.startTime) / 1000 / 60 / 60);
                if (!currentFast.activities) currentFast.activities = [];
                currentFast.activities = currentFast.activities.filter(a => a.id !== selectedActivity.id);
                currentFast.activities.push(activityLog);
                await saveCurrentFast();
            }
            dailyData.activities = dailyData.activities.filter(a => a.id !== selectedActivity.id); 
            dailyData.activities.push(activityLog); 
            updateActivityLogDisplay(); 
            renderActivityGrid(); 
            await saveDailyData(); 
            await calculateAllStreaks(); 
            closeActivityModal(); 
            showToast(`${selectedActivity.icon} ${selectedActivity.name} logged!`); 
        }
        function updateActivityLogDisplay() { const container = document.getElementById('activityLog'); if (dailyData.activities.length === 0) { container.classList.add('hidden'); return; } container.classList.remove('hidden'); document.getElementById('activityLogList').innerHTML = dailyData.activities.map(a => `<div class="activity-log-item"><span>${a.icon} ${a.name}</span><span>${a.duration} min</span></div>`).join(''); }

        // Journal
        function updateJournalPrompts() { let hours = 0; if (currentFast && currentFast.startTime) { hours = Math.floor((Date.now() - currentFast.startTime) / 1000 / 60 / 60); } let prompts = JOURNAL_PROMPTS[0]; if (hours >= 24) prompts = JOURNAL_PROMPTS[24]; else if (hours >= 16) prompts = JOURNAL_PROMPTS[16]; else if (hours >= 12) prompts = JOURNAL_PROMPTS[12]; else if (hours >= 8) prompts = JOURNAL_PROMPTS[8]; else if (hours >= 4) prompts = JOURNAL_PROMPTS[4]; document.getElementById('journalPromptsList').innerHTML = prompts.map(p => `<div class="journal-prompt-item"><div class="journal-prompt-checkbox ${dailyData.journalChecks[p.id] ? 'checked' : ''}" onclick="toggleJournalPrompt('${p.id}')">${dailyData.journalChecks[p.id] ? '‚úì' : ''}</div><div class="journal-prompt-text ${dailyData.journalChecks[p.id] ? 'completed' : ''}">${p.text}</div></div>`).join(''); }
        async function toggleJournalPrompt(promptId) { 
            dailyData.journalChecks[promptId] = !dailyData.journalChecks[promptId]; 
            // Save to current fast with timestamp and fasting hour
            if (currentFast) {
                if (!currentFast.journalEntries) currentFast.journalEntries = [];
                const hours = Math.floor((Date.now() - currentFast.startTime) / 1000 / 60 / 60);
                const existingIdx = currentFast.journalEntries.findIndex(e => e.promptId === promptId);
                if (dailyData.journalChecks[promptId]) {
                    const entry = { promptId, checked: true, timestamp: Date.now(), fastingHour: hours };
                    if (existingIdx >= 0) currentFast.journalEntries[existingIdx] = entry;
                    else currentFast.journalEntries.push(entry);
                } else {
                    if (existingIdx >= 0) currentFast.journalEntries[existingIdx].checked = false;
                }
                await saveCurrentFast();
            }
            updateJournalPrompts(); 
            await saveDailyData(); 
            await calculateAllStreaks(); 
        }

        // Timer
        function startFast() { const goal = parseInt(document.getElementById('goalInput').value) || 16; currentFast = { startTime: Date.now(), goal, notes: '', journalEntries: [], activities: [] }; dailyData.journalChecks = {}; dailyData.activities = []; document.getElementById('startBtn').classList.add('hidden'); document.getElementById('stopBtn').classList.remove('hidden'); document.getElementById('cancelBtn').classList.remove('hidden'); saveCurrentFast(); saveDailyData(); renderActivityGrid(); updateActivityLogDisplay(); startTimer(); updateJournalPrompts(); showToast('‚è±Ô∏è Fast started!'); }
        async function endFast() { 
            if (!currentFast) return; 
            const duration = (Date.now() - currentFast.startTime) / 1000 / 60 / 60; 
            const endWeight = prompt('Current weight (lbs)?', ''); 
            const record = { 
                ...currentFast, 
                endTime: Date.now(), 
                duration, 
                endWeight: parseFloat(endWeight) || null, 
                notes: document.getElementById('notesInput').value, 
                water: dailyData.water, 
                teas: dailyData.teas || [],
                activities: currentFast.activities || dailyData.activities || [],
                journalEntries: currentFast.journalEntries || [],
                journalChecks: {...dailyData.journalChecks},
                completed: true,
                metadata: {
                    goalMet: duration >= currentFast.goal,
                    percentOfGoal: Math.round((duration / currentFast.goal) * 100),
                    totalActivities: (currentFast.activities || dailyData.activities || []).length,
                    hadMeditation: (currentFast.activities || dailyData.activities || []).some(a => a.category === 'mindfulness'),
                    hadExercise: (currentFast.activities || dailyData.activities || []).some(a => a.category === 'exercise'),
                    journalPromptsCompleted: Object.values(dailyData.journalChecks).filter(v => v).length,
                    dayOfWeek: new Date().toLocaleDateString('en-US', { weekday: 'long' }),
                    startHour: new Date(currentFast.startTime).getHours()
                }
            }; 
            await database.ref(`users/${currentUser.uid}/history`).push(record); 
            await database.ref(`users/${currentUser.uid}/currentFast`).remove(); 
            if (endWeight) { 
                await database.ref(`users/${currentUser.uid}/profile/weight`).set(parseFloat(endWeight)); 
                document.getElementById('currentWeight').textContent = endWeight + ' lbs'; 
                await logWeightToHistory(parseFloat(endWeight)); 
            } 
            dailyData.journalChecks = {}; 
            dailyData.activities = [];
            await saveDailyData(); 
            renderActivityGrid();
            updateActivityLogDisplay();
            currentFast = null; 
            stopTimer(); 
            resetTimerUI(); 
            await loadHistory(); 
            await loadWeightHistory(); 
            await calculateAllStreaks(); 
            await updateAchievements(); 
            showToast('‚úÖ Fast completed!'); 
        }
        async function cancelFast() { if (!confirm('Cancel this fast?')) return; await database.ref(`users/${currentUser.uid}/currentFast`).remove(); currentFast = null; stopTimer(); resetTimerUI(); showToast('‚ùå Fast cancelled'); }
        function resetTimerUI() { document.getElementById('startBtn').classList.remove('hidden'); document.getElementById('stopBtn').classList.add('hidden'); document.getElementById('cancelBtn').classList.add('hidden'); document.getElementById('notesInput').value = ''; document.getElementById('timerDisplay').textContent = '00:00:00'; document.getElementById('metabolicZone').className = 'metabolic-zone zone-anabolic'; document.getElementById('metabolicZone').textContent = 'üîµ Ready to Start'; document.getElementById('timerStats').textContent = ''; updateJournalPrompts(); }
        async function saveCurrentFast() { if (!currentFast) return; currentFast.notes = document.getElementById('notesInput').value; await database.ref(`users/${currentUser.uid}/currentFast`).set(currentFast); setSyncBadge('synced'); }
        function startTimer() { updateTimer(); timerInterval = setInterval(updateTimer, 1000); }
        function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }
        function updateTimer() { if (!currentFast || !currentFast.startTime) return; const elapsed = Date.now() - currentFast.startTime; const hours = Math.floor(elapsed / 1000 / 60 / 60); const minutes = Math.floor((elapsed / 1000 / 60) % 60); const seconds = Math.floor((elapsed / 1000) % 60); document.getElementById('timerDisplay').textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; updateMetabolicZone(hours); updateJournalPrompts(); const goal = currentFast.goal || 16; const progress = Math.min(100, (hours / goal) * 100); let stats = `Goal: ${goal}h | Progress: ${Math.round(progress)}%`; if (hours < goal) { const goalTime = new Date(currentFast.startTime + (goal * 60 * 60 * 1000)); stats += ` | Complete: ${goalTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`; } else { stats += ' | ‚úÖ Goal Reached!'; } document.getElementById('timerStats').textContent = stats; }
        function updateMetabolicZone(hours) { const zone = document.getElementById('metabolicZone'); const z = customZones; if (hours < z.catabolic) { zone.className = 'metabolic-zone zone-anabolic'; zone.textContent = `üîµ Anabolic (0-${z.catabolic}h) - Digestion`; } else if (hours < z.fatBurn) { zone.className = 'metabolic-zone zone-catabolic'; zone.textContent = `üü† Catabolic (${z.catabolic}-${z.fatBurn}h) - Glycogen Usage`; } else if (hours < z.ketosis) { zone.className = 'metabolic-zone zone-fat-burning'; zone.textContent = `üü¢ Fat Burning (${z.fatBurn}-${z.ketosis}h) - Switching to Fat`; } else if (hours < z.deepKetosis) { zone.className = 'metabolic-zone zone-ketosis'; zone.textContent = `üü£ Ketosis (${z.ketosis}-${z.deepKetosis}h) - Producing Ketones`; } else if (hours < z.autophagy) { zone.className = 'metabolic-zone zone-deep-ketosis'; zone.textContent = `üî¥ Deep Ketosis (${z.deepKetosis}-${z.autophagy}h) - Full Ketone Power`; } else { zone.className = 'metabolic-zone zone-autophagy'; zone.textContent = `üß¨ Autophagy (${z.autophagy}h+) - Cellular Renewal`; } }

        // Weight
        async function logWeight() { const weight = parseFloat(document.getElementById('weightInput').value); if (!weight || weight < 50 || weight > 700) { showToast('Enter valid weight', 'error'); return; } await logWeightToHistory(weight); const profile = (await database.ref(`users/${currentUser.uid}/profile`).once('value')).val() || {}; if (!profile.startWeight) await database.ref(`users/${currentUser.uid}/profile/startWeight`).set(weight); await database.ref(`users/${currentUser.uid}/profile/weight`).set(weight); document.getElementById('currentWeight').textContent = weight + ' lbs'; document.getElementById('weightInput').value = ''; await loadWeightHistory(); await calculateAllStreaks(); await updateAchievements(); showToast('‚öñÔ∏è Weight logged!'); }
        async function logWeightToHistory(weight) { const today = new Date().toISOString().split('T')[0]; await database.ref(`users/${currentUser.uid}/weightHistory/${today}`).set({ weight, timestamp: Date.now() }); }
        async function loadWeightHistory() { const profile = (await database.ref(`users/${currentUser.uid}/profile`).once('value')).val() || {}; const weightSnap = await database.ref(`users/${currentUser.uid}/weightHistory`).orderByKey().limitToLast(30).once('value'); const history = []; weightSnap.forEach(c => history.push({ date: c.key, ...c.val() })); if (profile.startWeight) document.getElementById('startingWeight').textContent = profile.startWeight + ' lbs'; if (profile.weight) document.getElementById('currentWeight').textContent = profile.weight + ' lbs'; if (profile.startWeight && profile.weight) { const loss = profile.startWeight - profile.weight; if (loss > 0) { document.getElementById('weightLost').textContent = loss.toFixed(1) + ' lbs'; document.getElementById('weightLossAmount').textContent = loss.toFixed(1); document.getElementById('weightLossBadge').classList.remove('hidden'); } else { document.getElementById('weightLost').textContent = '‚Äî'; document.getElementById('weightLossBadge').classList.add('hidden'); } updateWeightMilestones(loss, profile.startWeight); } renderWeightChart(history); }
        function updateWeightMilestones(weightLoss, startWeight) { const milestones = [5, 10, 15, 20, 25, 30].filter(m => m <= startWeight - 100); const display = milestones.length >= 4 ? milestones.slice(0, 6) : [5, 10, 15, 20, 25, 30].slice(0, 6); const next = display.find(m => m > weightLoss); document.getElementById('weightMilestones').innerHTML = display.map(m => `<div class="weight-milestone ${weightLoss >= m ? 'achieved' : ''} ${m === next ? 'next' : ''}"><div class="weight-milestone-value">${weightLoss >= m ? '‚úì' : m}</div><div class="weight-milestone-label">${m} lbs</div></div>`).join(''); }
        function renderWeightChart(history) { const chart = document.getElementById('weightChart'); if (history.length === 0) { chart.innerHTML = '<div style="text-align: center; color: #999; padding: 60px 20px;">No weight data yet</div>'; return; } const last7 = history.slice(-7); const weights = last7.map(w => w.weight); const min = Math.min(...weights) - 2; const max = Math.max(...weights) + 2; const range = max - min || 1; chart.innerHTML = last7.map(e => { const h = ((e.weight - min) / range) * 80 + 10; const day = new Date(e.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short' }); return `<div class="weight-bar" style="height: ${h}%"><div class="weight-bar-value">${e.weight}</div><div class="weight-bar-label">${day}</div></div>`; }).join(''); }

        // Streaks
        async function calculateAllStreaks() { const uid = currentUser.uid; const dailySnap = await database.ref(`users/${uid}/daily`).once('value'); const daily = {}; dailySnap.forEach(c => { daily[c.key] = c.val(); }); const histSnap = await database.ref(`users/${uid}/history`).once('value'); const hist = []; histSnap.forEach(c => hist.push({ id: c.key, ...c.val() })); const weightSnap = await database.ref(`users/${uid}/weightHistory`).once('value'); const weights = {}; weightSnap.forEach(c => { weights[c.key] = c.val(); }); const profile = (await database.ref(`users/${uid}/profile`).once('value')).val() || { waterGoal: 8 };
            const fastingStreak = calcStreak(hist.map(f => new Date(f.startTime).toISOString().split('T')[0]));
            const waterStreak = calcStreakFromDaily(daily, d => d.water >= (profile.waterGoal || 8));
            const meditationStreak = calcStreakFromDaily(daily, d => (d.activities || []).some(a => a.category === 'mindfulness'));
            const exerciseStreak = calcStreakFromDaily(daily, d => (d.activities || []).some(a => a.category === 'exercise'));
            const journalStreak = calcStreakFromDaily(daily, d => Object.values(d.journalChecks || {}).some(v => v));
            const weightLogStreak = calcStreak(Object.keys(weights));
            const perfectDayStreak = calcStreakFromDaily(daily, d => { const date = d.date || Object.keys(daily).find(k => daily[k] === d); const hasFast = hist.some(f => new Date(f.startTime).toISOString().split('T')[0] === date); return hasFast && d.water >= (profile.waterGoal || 8) && (d.activities || []).length > 0; });
            document.getElementById('currentStreak').textContent = fastingStreak;
            document.getElementById('fastingStreakVal').textContent = fastingStreak;
            document.getElementById('waterStreakVal').textContent = waterStreak;
            document.getElementById('meditationStreakVal').textContent = meditationStreak;
            document.getElementById('exerciseStreakVal').textContent = exerciseStreak;
            document.getElementById('journalStreakVal').textContent = journalStreak;
            document.getElementById('weightLogStreakVal').textContent = weightLogStreak;
            document.getElementById('perfectDayStreakVal').textContent = perfectDayStreak;
            [['streakFasting', fastingStreak], ['streakWater', waterStreak], ['streakMeditation', meditationStreak], ['streakExercise', exerciseStreak], ['streakJournal', journalStreak], ['streakWeightLog', weightLogStreak], ['streakPerfectDay', perfectDayStreak]].forEach(([id, val]) => { const el = document.getElementById(id); if (val >= 3) el.classList.add('active'); else el.classList.remove('active'); });
            const uniqueDates = [...new Set(hist.map(f => new Date(f.startTime).toDateString()))]; let longest = 0, temp = 1; for (let i = 1; i < uniqueDates.length; i++) { if ((new Date(uniqueDates[i]) - new Date(uniqueDates[i-1])) / 86400000 === 1) { temp++; longest = Math.max(longest, temp); } else temp = 1; } longest = Math.max(longest, temp, fastingStreak); document.getElementById('longestStreak').textContent = longest;
            return { fastingStreak, waterStreak, meditationStreak, exerciseStreak, journalStreak, weightLogStreak, perfectDayStreak }; }
        function calcStreak(dates) { if (!dates || dates.length === 0) return 0; const unique = [...new Set(dates)].sort().reverse(); const today = new Date().toISOString().split('T')[0]; const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0]; if (unique[0] !== today && unique[0] !== yesterday) return 0; let streak = 1; for (let i = 1; i < unique.length; i++) { if ((new Date(unique[i-1] + 'T00:00:00') - new Date(unique[i] + 'T00:00:00')) / 86400000 === 1) streak++; else break; } return streak; }
        function calcStreakFromDaily(daily, condition) { const dates = Object.keys(daily).filter(date => { const d = daily[date]; d.date = date; return condition(d); }).sort().reverse(); return calcStreak(dates); }

        // Achievements
        async function updateAchievements() { const uid = currentUser.uid; const hist = []; (await database.ref(`users/${uid}/history`).once('value')).forEach(c => hist.push(c.val())); const profile = (await database.ref(`users/${uid}/profile`).once('value')).val() || {}; const streaks = await calculateAllStreaks();
            const data = { totalFasts: hist.length, fastingStreak: streaks.fastingStreak, waterStreak: streaks.waterStreak, meditationStreak: streaks.meditationStreak, exerciseStreak: streaks.exerciseStreak, perfectDayStreak: streaks.perfectDayStreak, ketosisCount: hist.filter(f => f.duration >= 12).length, longest24Plus: hist.some(f => f.duration >= 24), totalHours: hist.reduce((s, f) => s + (f.duration || 0), 0), weightLoss: profile.startWeight ? Math.max(0, profile.startWeight - (profile.weight || profile.startWeight)) : 0 };
            document.getElementById('achievementsGrid').innerHTML = ACHIEVEMENTS.map(a => `<div class="achievement ${a.check(data) ? '' : 'locked'}" title="${a.desc}"><div class="achievement-icon">${a.icon}</div><div class="achievement-name">${a.name}</div><div class="achievement-desc">${a.desc}</div></div>`).join(''); }

        // History & Stats
        let historyData = []; // Store for detail view
        async function loadHistory() { 
            historyData = []; 
            (await database.ref(`users/${currentUser.uid}/history`).once('value')).forEach(c => historyData.push({ id: c.key, ...c.val() })); 
            historyData.sort((a, b) => b.startTime - a.startTime); 
            document.getElementById('historyTableBody').innerHTML = historyData.length === 0 
                ? '<tr><td colspan="8" style="text-align: center; color: #999;">No fasting history yet</td></tr>' 
                : historyData.map((f, idx) => {
                    const journalCount = Object.values(f.journalChecks || {}).filter(v => v).length;
                    const goalMet = f.duration >= f.goal;
                    return `<tr>
                        <td>${new Date(f.startTime).toLocaleDateString()}</td>
                        <td style="color: ${goalMet ? 'var(--success)' : 'inherit'}; font-weight: ${goalMet ? '700' : 'normal'}">${f.duration.toFixed(1)}h ${goalMet ? '‚úì' : ''}</td>
                        <td>${f.goal}h</td>
                        <td>${f.endWeight ? f.endWeight + ' lbs' : '‚Äî'}</td>
                        <td>${f.water || '‚Äî'}</td>
                        <td>${(f.activities || []).map(a => a.icon).join(' ') || '‚Äî'}</td>
                        <td>${journalCount > 0 ? 'üìù ' + journalCount : '‚Äî'}</td>
                        <td><button onclick="showFastDetail(${idx})" style="padding: 6px 12px; background: var(--gradient-1); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85em;">View</button></td>
                    </tr>`;
                }).join(''); 
            updateStatistics(historyData); 
        }
        function updateStatistics(hist) { if (hist.length === 0) { document.getElementById('avgDuration').textContent = '‚Äî'; document.getElementById('totalHours').textContent = '‚Äî'; document.getElementById('totalFasts').textContent = '0'; document.getElementById('goalSuccess').textContent = '‚Äî'; return; } const total = hist.reduce((s, f) => s + f.duration, 0); const goals = hist.filter(f => f.duration >= f.goal).length; document.getElementById('avgDuration').textContent = (total / hist.length).toFixed(1) + 'h'; document.getElementById('totalHours').textContent = Math.round(total) + 'h'; document.getElementById('totalFasts').textContent = hist.length; document.getElementById('goalSuccess').textContent = Math.round(goals / hist.length * 100) + '%'; database.ref(`users/${currentUser.uid}/daily`).once('value').then(snap => { let tw = 0, wd = 0; snap.forEach(c => { const d = c.val(); if (d.water) { tw += d.water; wd++; } }); document.getElementById('waterAvg').textContent = wd > 0 ? (tw / wd).toFixed(1) + ' cups' : '‚Äî'; }); }

        // Fast Detail View
        function showFastDetail(idx) {
            const f = historyData[idx];
            if (!f) return;
            
            const startDate = new Date(f.startTime);
            const endDate = f.endTime ? new Date(f.endTime) : null;
            const goalMet = f.duration >= f.goal;
            const meta = f.metadata || {};
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div class="stat-box"><div class="stat-value">${f.duration.toFixed(1)}h</div><div class="stat-label">Duration</div></div>
                    <div class="stat-box"><div class="stat-value" style="${goalMet ? 'color: var(--success);' : ''}">${goalMet ? '‚úì Yes' : '‚úó No'}</div><div class="stat-label">Goal Met (${f.goal}h)</div></div>
                    <div class="stat-box"><div class="stat-value">${f.water || '‚Äî'}</div><div class="stat-label">Water (cups)</div></div>
                    <div class="stat-box"><div class="stat-value">${f.endWeight ? f.endWeight + ' lbs' : '‚Äî'}</div><div class="stat-label">End Weight</div></div>
                </div>
                
                <div style="background: #f8fafc; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <div style="font-weight: 700; color: var(--primary-dark); margin-bottom: 8px;">üìÖ Timing</div>
                    <div style="font-size: 0.9em; color: var(--text-muted);">
                        <div>Started: ${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</div>
                        ${endDate ? `<div>Ended: ${endDate.toLocaleDateString()} at ${endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</div>` : ''}
                        ${meta.dayOfWeek ? `<div>Day: ${meta.dayOfWeek}</div>` : ''}
                    </div>
                </div>`;
            
            // Activities
            if (f.activities && f.activities.length > 0) {
                html += `<div style="background: rgba(16,185,129,0.1); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <div style="font-weight: 700; color: var(--success); margin-bottom: 12px;">üèÉ Activities (${f.activities.length})</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${f.activities.map(a => `<div style="background: white; padding: 8px 12px; border-radius: 8px; font-size: 0.9em;">
                            ${a.icon} ${a.name} <span style="color: var(--text-muted);">${a.duration}min${a.fastingHour !== undefined ? ' @' + a.fastingHour + 'h' : ''}</span>
                        </div>`).join('')}
                    </div>
                </div>`;
            }
            
            // Journal Entries
            const journalChecked = Object.entries(f.journalChecks || {}).filter(([k, v]) => v);
            if (journalChecked.length > 0 || (f.journalEntries && f.journalEntries.length > 0)) {
                html += `<div style="background: rgba(99,102,241,0.1); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <div style="font-weight: 700; color: var(--primary); margin-bottom: 12px;">üìù Journal Check-ins (${journalChecked.length})</div>
                    <div style="font-size: 0.9em;">
                        ${journalChecked.map(([promptId, _]) => {
                            const allPrompts = Object.values(JOURNAL_PROMPTS).flat();
                            const prompt = allPrompts.find(p => p.id === promptId);
                            const entry = (f.journalEntries || []).find(e => e.promptId === promptId);
                            return `<div style="padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.05);">
                                ‚úì ${prompt ? prompt.text : promptId}
                                ${entry && entry.fastingHour !== undefined ? `<span style="color: var(--text-muted);"> (at ${entry.fastingHour}h)</span>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            }
            
            // Notes
            if (f.notes) {
                html += `<div style="background: #f8fafc; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <div style="font-weight: 700; color: var(--primary-dark); margin-bottom: 8px;">üìì Notes</div>
                    <div style="font-size: 0.95em; white-space: pre-wrap;">${f.notes}</div>
                </div>`;
            }
            
            // Teas
            if (f.teas && f.teas.length > 0) {
                html += `<div style="background: rgba(139,195,74,0.1); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <div style="font-weight: 700; color: #689f38; margin-bottom: 12px;">üçµ Teas (${f.teas.length})</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${f.teas.map(t => `<div style="background: white; padding: 6px 10px; border-radius: 6px; font-size: 0.85em;">${t.icon} ${t.name}</div>`).join('')}
                    </div>
                </div>`;
            }
            
            // Correlation Metadata
            if (meta && Object.keys(meta).length > 0) {
                html += `<div style="background: linear-gradient(135deg, rgba(99,102,241,0.05), rgba(168,85,247,0.05)); padding: 16px; border-radius: 12px;">
                    <div style="font-weight: 700; color: var(--primary-dark); margin-bottom: 12px;">üìä Correlation Data</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; font-size: 0.85em;">
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 8px;"><div style="font-weight: 700;">${meta.percentOfGoal || 0}%</div><div style="color: var(--text-muted);">Goal %</div></div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 8px;"><div style="font-weight: 700;">${meta.hadMeditation ? '‚úì' : '‚úó'}</div><div style="color: var(--text-muted);">Meditation</div></div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 8px;"><div style="font-weight: 700;">${meta.hadExercise ? '‚úì' : '‚úó'}</div><div style="color: var(--text-muted);">Exercise</div></div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 8px;"><div style="font-weight: 700;">${meta.journalPromptsCompleted || 0}</div><div style="color: var(--text-muted);">Journal ‚úì</div></div>
                    </div>
                </div>`;
            }
            
            document.getElementById('fastDetailContent').innerHTML = html;
            document.getElementById('fastDetailModal').classList.add('show');
        }
        
        function closeFastDetailModal() {
            document.getElementById('fastDetailModal').classList.remove('show');
        }

        // Profile
        function showProfileModal() { database.ref(`users/${currentUser.uid}/profile`).once('value').then(snap => { const p = snap.val() || {}; document.getElementById('profileStartWeight').value = p.startWeight || ''; document.getElementById('profileGoalWeight').value = p.goalWeight || ''; document.getElementById('profileWaterGoal').value = p.waterGoal || 8; document.getElementById('zoneCatabolic').value = p.zones?.catabolic || 4; document.getElementById('zoneFatBurn').value = p.zones?.fatBurn || 8; document.getElementById('zoneKetosis').value = p.zones?.ketosis || 12; document.getElementById('zoneDeepKetosis').value = p.zones?.deepKetosis || 16; document.getElementById('zoneAutophagy').value = p.zones?.autophagy || 24; }); document.getElementById('profileModal').classList.add('show'); }
        function closeProfileModal() { document.getElementById('profileModal').classList.remove('show'); }
        async function saveProfile() { const profile = { startWeight: parseFloat(document.getElementById('profileStartWeight').value) || null, goalWeight: parseFloat(document.getElementById('profileGoalWeight').value) || null, waterGoal: parseInt(document.getElementById('profileWaterGoal').value) || 8, zones: { catabolic: parseInt(document.getElementById('zoneCatabolic').value) || 4, fatBurn: parseInt(document.getElementById('zoneFatBurn').value) || 8, ketosis: parseInt(document.getElementById('zoneKetosis').value) || 12, deepKetosis: parseInt(document.getElementById('zoneDeepKetosis').value) || 16, autophagy: parseInt(document.getElementById('zoneAutophagy').value) || 24 } }; customZones = profile.zones; const current = (await database.ref(`users/${currentUser.uid}/profile/weight`).once('value')).val(); if (current) profile.weight = current; await database.ref(`users/${currentUser.uid}/profile`).update(profile); if (profile.startWeight) document.getElementById('startingWeight').textContent = profile.startWeight + ' lbs'; document.getElementById('waterGoal').textContent = profile.waterGoal; updateWaterDisplay(); await loadWeightHistory(); if (currentFast) updateTimer(); closeProfileModal(); showToast('üíæ Profile saved!'); }

        // Export
        function exportToExcel() { 
            if (historyData.length === 0) { showToast('No data to export', 'warning'); return; } 
            let csv = 'Date,Day,Start Hour,Duration (hours),Goal (hours),Goal Met,Percent of Goal,End Weight,Water (cups),Activities,Had Meditation,Had Exercise,Journal Prompts Completed,Teas,Notes\n'; 
            historyData.forEach(f => { 
                const meta = f.metadata || {};
                csv += `${new Date(f.startTime).toLocaleDateString()},${meta.dayOfWeek || ''},${meta.startHour || ''},${f.duration.toFixed(2)},${f.goal},${meta.goalMet ? 'Yes' : 'No'},${meta.percentOfGoal || 0}%,${f.endWeight || ''},${f.water || ''},"${(f.activities || []).map(a => a.name + '(' + a.duration + 'min)').join('; ')}",${meta.hadMeditation ? 'Yes' : 'No'},${meta.hadExercise ? 'Yes' : 'No'},${meta.journalPromptsCompleted || 0},"${(f.teas || []).map(t => t.name).join('; ')}","${(f.notes || '').replace(/"/g, "'")}"\n`; 
            }); 
            const blob = new Blob([csv], { type: 'text/csv' }); 
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = `fasting-history-${new Date().toISOString().split('T')[0]}.csv`; 
            a.click(); 
            showToast('üì• Exported with correlation data!'); 
        }

        // Utilities
        function setSyncBadge(status) { const badge = document.getElementById('cloudSyncBadge'); if (status === 'syncing') { badge.className = 'cloud-sync-badge syncing'; badge.textContent = '‚òÅÔ∏è Syncing...'; } else { badge.className = 'cloud-sync-badge'; badge.textContent = '‚òÅÔ∏è Synced'; } }
        function showToast(msg, type = 'success') { const toast = document.createElement('div'); toast.className = 'toast' + (type !== 'success' ? ' ' + type : ''); toast.textContent = msg; document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000); }
        document.getElementById('notesInput').addEventListener('input', () => { if (currentFast) { setSyncBadge('syncing'); clearTimeout(window.notesSaveTimeout); window.notesSaveTimeout = setTimeout(saveCurrentFast, 1000); } });
    </script>
</body>
</html>
