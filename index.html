<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Fasting Tracker - Phase 1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Auth Screen Styles */
        .auth-container {
            max-width: 450px;
            margin: 50px auto;
        }
        
        .auth-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .auth-logo {
            text-align: center;
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .auth-title {
            text-align: center;
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .auth-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #667eea;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-auth {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #f5f5f5;
        }
        
        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }
        
        .auth-switch a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }
        
        .auth-switch a:hover {
            text-decoration: underline;
        }
        
        /* Main App Styles */
        .hidden {
            display: none !important;
        }
        
        .header {
            background: white;
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-title h1 {
            color: #667eea;
            font-size: 2em;
        }
        
        .cloud-sync-badge {
            background: #4CAF50;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .cloud-sync-badge.syncing {
            background: #FF9800;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-email {
            color: #666;
        }
        
        .btn-logout {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-logout:hover {
            background: #d32f2f;
        }
        
        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Water Tracking Card */
        .water-tracker {
            text-align: center;
        }
        
        .water-goal {
            font-size: 3em;
            font-weight: bold;
            color: #2196F3;
            margin: 10px 0;
        }
        
        .water-goal-label {
            color: #666;
            margin-bottom: 15px;
        }
        
        .water-progress {
            background: #e0e0e0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .water-progress-fill {
            background: linear-gradient(90deg, #2196F3, #03A9F4);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .water-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-water {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #2196F3, #03A9F4);
            color: white;
        }
        
        .btn-water:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        .btn-water:active {
            transform: translateY(0);
        }
        
        /* Tea Tracking Card */
        .tea-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .tea-button {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 0.9em;
        }
        
        .tea-button:hover {
            border-color: #8BC34A;
            background: #f1f8e9;
            transform: translateY(-2px);
        }
        
        .tea-button .tea-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .tea-button .tea-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .tea-button .tea-benefit {
            font-size: 0.75em;
            color: #666;
        }
        
        .tea-today {
            margin-top: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .tea-today-title {
            font-weight: bold;
            color: #8BC34A;
            margin-bottom: 8px;
        }
        
        .tea-log-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tea-log-item:last-child {
            border-bottom: none;
        }
        
        /* Mood Tracking Card */
        .mood-tracker {
            text-align: center;
        }
        
        .mood-question {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 20px;
        }
        
        .mood-emojis {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .mood-emoji {
            font-size: 3em;
            cursor: pointer;
            transition: all 0.3s;
            padding: 10px;
            border-radius: 50%;
        }
        
        .mood-emoji:hover {
            transform: scale(1.2);
            background: #f5f5f5;
        }
        
        .mood-emoji.selected {
            transform: scale(1.3);
            background: #FFF3E0;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        
        .mood-history {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        
        .mood-history-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #FF9800;
        }
        
        .mood-chart {
            display: flex;
            gap: 5px;
            height: 50px;
            align-items: flex-end;
            margin-top: 10px;
        }
        
        .mood-bar {
            flex: 1;
            background: linear-gradient(to top, #FFB74D, #FFA726);
            border-radius: 4px 4px 0 0;
            transition: height 0.3s;
            position: relative;
        }
        
        .mood-bar:hover::after {
            content: attr(data-mood);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            white-space: nowrap;
        }
        
        /* Streaks & Achievements Card */
        .streaks-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .streaks-card .card-title {
            color: white;
        }
        
        .streak-display {
            text-align: center;
            margin: 20px 0;
        }
        
        .streak-number {
            font-size: 4em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .streak-label {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .streak-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .streak-stat {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .streak-stat-number {
            font-size: 2em;
            font-weight: bold;
        }
        
        .streak-stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        /* Achievements Section */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .achievement {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .achievement.locked {
            opacity: 0.4;
        }
        
        .achievement:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .achievement-icon {
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        
        .achievement-name {
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .achievement-desc {
            font-size: 0.7em;
            opacity: 0.8;
            margin-top: 3px;
        }
        
        /* Fasting Timer Card */
        .timer-display {
            text-align: center;
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        
        .metabolic-zone {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .zone-anabolic { background: #E3F2FD; color: #1976D2; }
        .zone-catabolic { background: #FFF3E0; color: #F57C00; }
        .zone-fat-burning { background: #E8F5E9; color: #388E3C; }
        .zone-ketosis { background: #F3E5F5; color: #7B1FA2; }
        .zone-deep-ketosis { background: #FCE4EC; color: #C2185B; }
        .zone-autophagy { background: #E0F2F1; color: #00796B; }
        
        .timer-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #f44336, #e91e63);
            color: white;
        }
        
        .btn-cancel {
            background: linear-gradient(135deg, #FF9800, #FF5722);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        /* Stats Card */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-box {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        /* History Section */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .history-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .history-table tr:hover {
            background: #f5f5f5;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5em;
            color: #667eea;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .tea-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.error {
            background: #f44336;
        }
        
        .toast.warning {
            background: #FF9800;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">‚è±Ô∏è</div>
            <h1 class="auth-title">Fasting Tracker</h1>
            <p class="auth-subtitle">Track your fasting journey with cloud sync</p>
            
            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div class="auth-buttons">
                    <button class="btn-auth btn-primary" onclick="login()">Login</button>
                </div>
                <div class="auth-switch">
                    Don't have an account? <a href="#" onclick="showSignup(); return false;">Sign up</a>
                </div>
            </div>
            
            <div id="signupForm" class="hidden">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="signupPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div class="auth-buttons">
                    <button class="btn-auth btn-primary" onclick="signup()">Create Account</button>
                </div>
                <div class="auth-switch">
                    Already have an account? <a href="#" onclick="showLogin(); return false;">Login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appScreen" class="container hidden">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1>‚è±Ô∏è Fasting Tracker</h1>
                <div id="cloudSyncBadge" class="cloud-sync-badge">
                    ‚òÅÔ∏è Synced
                </div>
            </div>
            <div class="user-info">
                <span class="user-email" id="userEmail"></span>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard">
            <!-- Water Tracking Card -->
            <div class="card water-tracker">
                <div class="card-title">üíß Hydration</div>
                <div class="water-goal" id="waterCount">0</div>
                <div class="water-goal-label">of <span id="waterGoal">8</span> cups today</div>
                <div class="water-progress">
                    <div class="water-progress-fill" id="waterProgressFill" style="width: 0%">
                        <span id="waterPercent">0%</span>
                    </div>
                </div>
                <div class="water-buttons">
                    <button class="btn-water" onclick="addWater(1)">üíß +1 Cup</button>
                    <button class="btn-water" onclick="addWater(-1)">‚ûñ -1 Cup</button>
                </div>
                <button class="btn-water" onclick="showTeaModal()" style="margin-top: 10px; width: 100%;">
                    üçµ Log Tea
                </button>
                <div id="teaToday" class="tea-today hidden">
                    <div class="tea-today-title">‚òï Today's Teas</div>
                    <div id="teaTodayList"></div>
                </div>
            </div>

            <!-- Mood Tracking Card -->
            <div class="card mood-tracker">
                <div class="card-title">üòä How Are You Feeling?</div>
                <div class="mood-question">Rate your mood today</div>
                <div class="mood-emojis">
                    <span class="mood-emoji" onclick="setMood(1)" data-mood="1">üò´</span>
                    <span class="mood-emoji" onclick="setMood(2)" data-mood="2">üòê</span>
                    <span class="mood-emoji" onclick="setMood(3)" data-mood="3">üôÇ</span>
                    <span class="mood-emoji" onclick="setMood(4)" data-mood="4">üòä</span>
                    <span class="mood-emoji" onclick="setMood(5)" data-mood="5">üòÑ</span>
                </div>
                <div id="moodHistory" class="mood-history hidden">
                    <div class="mood-history-title">Last 7 Days</div>
                    <div class="mood-chart" id="moodChart"></div>
                </div>
            </div>

            <!-- Streaks & Achievements Card -->
            <div class="card streaks-card">
                <div class="card-title">üî• Current Streak</div>
                <div class="streak-display">
                    <div class="streak-number" id="currentStreak">0</div>
                    <div class="streak-label">days</div>
                </div>
                <div class="streak-stats">
                    <div class="streak-stat">
                        <div class="streak-stat-number" id="longestStreak">0</div>
                        <div class="streak-stat-label">Longest</div>
                    </div>
                    <div class="streak-stat">
                        <div class="streak-stat-number" id="totalFasts">0</div>
                        <div class="streak-stat-label">Total Fasts</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div class="card-title">üèÜ Achievements</div>
                    <div class="achievements-grid" id="achievementsGrid"></div>
                </div>
            </div>

            <!-- Fasting Timer Card -->
            <div class="card">
                <div class="card-title">‚è±Ô∏è Current Fast</div>
                <div id="timerDisplay" class="timer-display">00:00:00</div>
                <div id="metabolicZone" class="metabolic-zone"></div>
                <div id="timerStats" style="text-align: center; color: #666; margin: 10px 0;"></div>
                <div class="timer-controls">
                    <button id="startBtn" class="btn btn-start" onclick="startFast()">Start Fast</button>
                    <button id="stopBtn" class="btn btn-stop hidden" onclick="endFast()">End Fast</button>
                    <button id="cancelBtn" class="btn btn-cancel hidden" onclick="cancelFast()">Cancel</button>
                </div>
                <div style="margin-top: 15px;">
                    <label style="font-weight: bold; color: #667eea;">Goal (hours):</label>
                    <input type="number" id="goalInput" value="16" min="1" max="72" 
                           style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0; margin-top: 5px;">
                </div>
                <div style="margin-top: 15px;">
                    <label style="font-weight: bold; color: #667eea;">Notes:</label>
                    <textarea id="notesInput" rows="3" 
                              style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0; margin-top: 5px; resize: vertical;"
                              placeholder="How are you feeling? Any observations?"></textarea>
                </div>
            </div>

            <!-- Profile & Stats Card -->
            <div class="card">
                <div class="card-title">üìä Profile & Stats</div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="currentWeight">-</div>
                        <div class="stat-label">Current Weight</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avgDuration">-</div>
                        <div class="stat-label">Avg Duration</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="totalHours">-</div>
                        <div class="stat-label">Total Hours</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="waterAvg">-</div>
                        <div class="stat-label">Avg Hydration</div>
                    </div>
                </div>
                <button class="btn btn-start" onclick="showProfileModal()" 
                        style="width: 100%; margin-top: 15px; background: linear-gradient(135deg, #667eea, #764ba2);">
                    Edit Profile
                </button>
            </div>
        </div>

        <!-- History Section -->
        <div class="card" style="margin-top: 20px;">
            <div class="card-title">üìú Fasting History</div>
            <button class="btn btn-start" onclick="exportToExcel()" 
                    style="margin-bottom: 15px; background: linear-gradient(135deg, #4CAF50, #8BC34A);">
                üì• Export to Excel
            </button>
            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Duration</th>
                            <th>Goal</th>
                            <th>Start Weight</th>
                            <th>End Weight</th>
                            <th>üíß Water</th>
                            <th>üòä Mood</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #999;">No fasting history yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tea Selection Modal -->
    <div id="teaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üçµ Select Tea</h2>
                <button class="modal-close" onclick="closeTeaModal()">√ó</button>
            </div>
            <div class="tea-grid" id="teaGrid"></div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üë§ Profile</h2>
                <button class="modal-close" onclick="closeProfileModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Current Weight (lbs)</label>
                <input type="number" id="profileWeight" step="0.1">
            </div>
            <div class="form-group">
                <label>Height (inches)</label>
                <input type="number" id="profileHeight" step="0.1">
            </div>
            <div class="form-group">
                <label>Body Fat % (optional)</label>
                <input type="number" id="profileBodyFat" step="0.1" min="0" max="100">
            </div>
            <div class="form-group">
                <label>Age</label>
                <input type="number" id="profileAge" min="1" max="120">
            </div>
            <div class="form-group">
                <label>Gender</label>
                <select id="profileGender" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e0e0e0;">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Daily Water Goal (cups)</label>
                <input type="number" id="profileWaterGoal" min="1" max="20" value="8">
            </div>
            <button class="btn btn-start" onclick="saveProfile()" 
                    style="width: 100%; background: linear-gradient(135deg, #667eea, #764ba2);">
                üíæ Save Profile
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAD037fOI7q5D2zPoqmvrBj6CPYuv4DJoM",
            authDomain: "fasting-tracker-1b50c.firebaseapp.com",
            databaseURL: "https://fasting-tracker-1b50c-default-rtdb.firebaseio.com",
            projectId: "fasting-tracker-1b50c",
            storageBucket: "fasting-tracker-1b50c.firebasestorage.app",
            messagingSenderId: "268148990974",
            appId: "1:268148990974:web:ba96a44fc3b1ea50838f69"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Tea Library with GLP-1 Properties
        const TEA_LIBRARY = [
            { 
                id: 'gynostemma', 
                name: 'Gynostemma', 
                icon: 'üçÉ', 
                benefit: 'Blood sugar control',
                hydration: 1.0,
                description: 'Adaptogenic herb, blood sugar regulation'
            },
            { 
                id: 'green', 
                name: 'Green Tea', 
                icon: 'üçµ', 
                benefit: 'Metabolism boost',
                hydration: 0.9,
                description: 'EGCG increases GLP-1, metabolism support'
            },
            { 
                id: 'ginger', 
                name: 'Ginger', 
                icon: 'ü´ö', 
                benefit: 'Appetite control',
                hydration: 1.0,
                description: 'Activates nutrient sensors, digestive aid'
            },
            { 
                id: 'chamomile', 
                name: 'Chamomile', 
                icon: 'üåº', 
                benefit: 'Calming',
                hydration: 1.0,
                description: 'Stress reduction, sleep support'
            },
            { 
                id: 'peppermint', 
                name: 'Peppermint', 
                icon: 'üåø', 
                benefit: 'Digestive',
                hydration: 1.0,
                description: 'Digestive support, mild appetite control'
            },
            { 
                id: 'matcha', 
                name: 'Matcha', 
                icon: 'üçµ', 
                benefit: 'Energy & focus',
                hydration: 0.85,
                description: 'High caffeine, sustained energy'
            },
            { 
                id: 'oolong', 
                name: 'Oolong', 
                icon: '‚òï', 
                benefit: 'Fat burning',
                hydration: 0.9,
                description: 'Metabolism support, moderate caffeine'
            },
            { 
                id: 'black', 
                name: 'Black Tea', 
                icon: '‚òï', 
                benefit: 'Energy',
                hydration: 0.8,
                description: 'Alertness, moderate caffeine'
            },
            { 
                id: 'cinnamon', 
                name: 'Cinnamon', 
                icon: 'ü™µ', 
                benefit: 'Blood sugar',
                hydration: 1.0,
                description: 'Blood sugar support, enhances GLP-1'
            }
        ];

        // Achievements System
        const ACHIEVEMENTS = [
            { id: 'first_fast', name: 'First Fast', icon: 'ü•á', desc: 'Complete your first fast', check: (data) => data.totalFasts >= 1 },
            { id: 'streak_3', name: '3 Day Streak', icon: 'üî•', desc: 'Fast 3 days in a row', check: (data) => data.currentStreak >= 3 },
            { id: 'streak_7', name: 'Week Warrior', icon: '‚ö°', desc: '7 day streak', check: (data) => data.currentStreak >= 7 },
            { id: 'ketosis_10', name: 'Ketosis King', icon: 'üéØ', desc: 'Reach ketosis 10 times', check: (data) => data.ketosisCount >= 10 },
            { id: 'streak_30', name: '30 Day Champion', icon: 'üí™', desc: '30 day streak', check: (data) => data.currentStreak >= 30 },
            { id: 'fast_24', name: 'Deep Diver', icon: 'üß¨', desc: 'Complete 24+ hour fast', check: (data) => data.longest24Plus },
            { id: 'hours_100', name: 'Century Club', icon: 'üèãÔ∏è', desc: '100 total hours fasted', check: (data) => data.totalHours >= 100 },
            { id: 'weight_5', name: '5 Pounds Down', icon: 'üìâ', desc: 'Lose 5 lbs', check: (data) => data.weightLoss >= 5 },
            { id: 'fat_burn_25', name: 'Fat Burner', icon: 'üåü', desc: 'Hit fat burning 25 times', check: (data) => data.fatBurnCount >= 25 },
            { id: 'fasts_50', name: 'Fasting Master', icon: 'üëë', desc: '50 fasts completed', check: (data) => data.totalFasts >= 50 }
        ];

        // Global State
        let currentUser = null;
        let timerInterval = null;
        let currentFast = null;
        let dailyData = {
            water: 0,
            teas: [],
            mood: null,
            date: new Date().toISOString().split('T')[0]
        };

        // Auth State Observer
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                showApp();
                loadUserData();
            } else {
                showAuth();
            }
        });

        // Auth Functions
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
        }

        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function signup() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupPasswordConfirm').value;
            
            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                // Initialize user data
                await database.ref(`users/${userCredential.user.uid}/profile`).set({
                    weight: 0,
                    height: 0,
                    age: 0,
                    gender: 'other',
                    waterGoal: 8,
                    createdAt: Date.now()
                });
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function logout() {
            auth.signOut();
        }

        function showAuth() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentUser.email;
        }

        // Load User Data
        async function loadUserData() {
            const userId = currentUser.uid;
            
            // Load profile
            const profileSnapshot = await database.ref(`users/${userId}/profile`).once('value');
            const profile = profileSnapshot.val() || { waterGoal: 8 };
            
            if (profile.weight) {
                document.getElementById('currentWeight').textContent = profile.weight + ' lbs';
            }
            
            document.getElementById('waterGoal').textContent = profile.waterGoal || 8;
            
            // Load current fast
            const currentFastSnapshot = await database.ref(`users/${userId}/currentFast`).once('value');
            currentFast = currentFastSnapshot.val();
            
            if (currentFast) {
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.remove('hidden');
                document.getElementById('cancelBtn').classList.remove('hidden');
                document.getElementById('goalInput').value = currentFast.goal || 16;
                document.getElementById('notesInput').value = currentFast.notes || '';
                startTimer();
            }
            
            // Load daily data
            await loadDailyData();
            
            // Load history and stats
            await loadHistory();
            
            // Update achievements
            updateAchievements();
            
            // Render tea grid
            renderTeaGrid();
        }

        // Daily Data Functions
        async function loadDailyData() {
            const userId = currentUser.uid;
            const today = new Date().toISOString().split('T')[0];
            
            const dailySnapshot = await database.ref(`users/${userId}/daily/${today}`).once('value');
            const data = dailySnapshot.val();
            
            if (data) {
                dailyData = { ...data, date: today };
            } else {
                dailyData = {
                    water: 0,
                    teas: [],
                    mood: null,
                    date: today
                };
            }
            
            updateWaterDisplay();
            updateMoodDisplay();
            updateTeaTodayDisplay();
        }

        async function saveDailyData() {
            const userId = currentUser.uid;
            await database.ref(`users/${userId}/daily/${dailyData.date}`).set(dailyData);
            setSyncBadge('synced');
        }

        // Water Tracking Functions
        async function addWater(amount) {
            dailyData.water = Math.max(0, dailyData.water + amount);
            updateWaterDisplay();
            await saveDailyData();
            
            if (amount > 0) {
                showToast('üíß Water logged!');
            }
        }

        function updateWaterDisplay() {
            const goal = parseInt(document.getElementById('waterGoal').textContent);
            const percent = Math.min(100, (dailyData.water / goal) * 100);
            
            document.getElementById('waterCount').textContent = dailyData.water;
            document.getElementById('waterProgressFill').style.width = percent + '%';
            document.getElementById('waterPercent').textContent = Math.round(percent) + '%';
        }

        // Tea Tracking Functions
        function renderTeaGrid() {
            const teaGrid = document.getElementById('teaGrid');
            teaGrid.innerHTML = '';
            
            TEA_LIBRARY.forEach(tea => {
                const button = document.createElement('div');
                button.className = 'tea-button';
                button.innerHTML = `
                    <div class="tea-icon">${tea.icon}</div>
                    <div class="tea-name">${tea.name}</div>
                    <div class="tea-benefit">${tea.benefit}</div>
                `;
                button.onclick = () => logTea(tea);
                teaGrid.appendChild(button);
            });
        }

        function showTeaModal() {
            document.getElementById('teaModal').classList.add('show');
        }

        function closeTeaModal() {
            document.getElementById('teaModal').classList.remove('show');
        }

        async function logTea(tea) {
            const teaLog = {
                id: tea.id,
                name: tea.name,
                icon: tea.icon,
                time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now()
            };
            
            dailyData.teas.push(teaLog);
            
            // Add to water count based on hydration multiplier
            dailyData.water += tea.hydration;
            
            updateWaterDisplay();
            updateTeaTodayDisplay();
            await saveDailyData();
            
            closeTeaModal();
            showToast(`üçµ ${tea.name} logged!`);
        }

        function updateTeaTodayDisplay() {
            const container = document.getElementById('teaToday');
            const list = document.getElementById('teaTodayList');
            
            if (dailyData.teas.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            list.innerHTML = '';
            
            dailyData.teas.forEach(tea => {
                const item = document.createElement('div');
                item.className = 'tea-log-item';
                item.innerHTML = `
                    <span>${tea.icon} ${tea.name}</span>
                    <span>${tea.time}</span>
                `;
                list.appendChild(item);
            });
        }

        // Mood Tracking Functions
        async function setMood(moodValue) {
            dailyData.mood = moodValue;
            
            // Update UI
            document.querySelectorAll('.mood-emoji').forEach(emoji => {
                emoji.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            await saveDailyData();
            await updateMoodChart();
            showToast('üòä Mood logged!');
        }

        function updateMoodDisplay() {
            if (dailyData.mood) {
                const emojis = document.querySelectorAll('.mood-emoji');
                emojis.forEach(emoji => {
                    emoji.classList.remove('selected');
                    if (parseInt(emoji.getAttribute('data-mood')) === dailyData.mood) {
                        emoji.classList.add('selected');
                    }
                });
            }
        }

        async function updateMoodChart() {
            const userId = currentUser.uid;
            const chart = document.getElementById('moodChart');
            const history = document.getElementById('moodHistory');
            
            // Get last 7 days of mood data
            const moods = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const snapshot = await database.ref(`users/${userId}/daily/${dateStr}/mood`).once('value');
                moods.push(snapshot.val() || 0);
            }
            
            // Render chart
            chart.innerHTML = '';
            moods.forEach((mood, index) => {
                const bar = document.createElement('div');
                bar.className = 'mood-bar';
                bar.style.height = (mood * 20) + '%';
                
                const moodEmojis = ['', 'üò´', 'üòê', 'üôÇ', 'üòä', 'üòÑ'];
                bar.setAttribute('data-mood', moodEmojis[mood] || '‚Äî');
                
                chart.appendChild(bar);
            });
            
            history.classList.remove('hidden');
        }

        // Fasting Timer Functions
        function startFast() {
            const goal = parseInt(document.getElementById('goalInput').value) || 16;
            
            currentFast = {
                startTime: Date.now(),
                goal: goal,
                notes: '',
                startWeight: parseFloat(document.getElementById('currentWeight').textContent) || 0
            };
            
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('stopBtn').classList.remove('hidden');
            document.getElementById('cancelBtn').classList.remove('hidden');
            
            saveCurrentFast();
            startTimer();
            showToast('‚è±Ô∏è Fast started!');
        }

        async function endFast() {
            if (!currentFast) return;
            
            const endTime = Date.now();
            const duration = (endTime - currentFast.startTime) / 1000 / 60 / 60; // hours
            
            // Prompt for end weight
            const endWeight = prompt('Enter your current weight (lbs):', document.getElementById('currentWeight').textContent);
            
            const fastRecord = {
                ...currentFast,
                endTime: endTime,
                duration: duration,
                endWeight: parseFloat(endWeight) || currentFast.startWeight,
                notes: document.getElementById('notesInput').value,
                water: dailyData.water,
                mood: dailyData.mood,
                teas: dailyData.teas,
                completed: true
            };
            
            // Save to history
            const userId = currentUser.uid;
            await database.ref(`users/${userId}/history`).push(fastRecord);
            
            // Clear current fast
            await database.ref(`users/${userId}/currentFast`).remove();
            
            // Update profile weight
            if (endWeight) {
                await database.ref(`users/${userId}/profile/weight`).set(parseFloat(endWeight));
                document.getElementById('currentWeight').textContent = endWeight + ' lbs';
            }
            
            // Reset UI
            currentFast = null;
            stopTimer();
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('notesInput').value = '';
            document.getElementById('timerDisplay').textContent = '00:00:00';
            document.getElementById('metabolicZone').textContent = '';
            document.getElementById('timerStats').textContent = '';
            
            // Reload data
            await loadHistory();
            updateAchievements();
            
            showToast('‚úÖ Fast completed!');
        }

        async function cancelFast() {
            if (!confirm('Cancel this fast? It will not be saved to your history.')) {
                return;
            }
            
            const userId = currentUser.uid;
            await database.ref(`users/${userId}/currentFast`).remove();
            
            currentFast = null;
            stopTimer();
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('notesInput').value = '';
            document.getElementById('timerDisplay').textContent = '00:00:00';
            document.getElementById('metabolicZone').textContent = '';
            document.getElementById('timerStats').textContent = '';
            
            showToast('‚ùå Fast cancelled');
        }

        async function saveCurrentFast() {
            if (!currentFast) return;
            
            currentFast.notes = document.getElementById('notesInput').value;
            
            const userId = currentUser.uid;
            await database.ref(`users/${userId}/currentFast`).set(currentFast);
            setSyncBadge('synced');
        }

        function startTimer() {
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimer() {
            if (!currentFast) return;
            
            const elapsed = Date.now() - currentFast.startTime;
            const hours = Math.floor(elapsed / 1000 / 60 / 60);
            const minutes = Math.floor((elapsed / 1000 / 60) % 60);
            const seconds = Math.floor((elapsed / 1000) % 60);
            
            document.getElementById('timerDisplay').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // Update metabolic zone
            updateMetabolicZone(hours);
            
            // Update stats
            const goal = currentFast.goal || 16;
            const progress = (hours / goal) * 100;
            const remaining = Math.max(0, goal - hours);
            
            let statsText = `Goal: ${goal}h | Progress: ${Math.round(progress)}%`;
            
            if (remaining > 0) {
                const goalTime = new Date(currentFast.startTime + (goal * 60 * 60 * 1000));
                const today = new Date();
                const isToday = goalTime.toDateString() === today.toDateString();
                const dayLabel = isToday ? 'Today' : 'Tomorrow';
                const timeStr = goalTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                statsText += ` | Complete: ${dayLabel} ${timeStr}`;
            } else {
                statsText += ' | ‚úÖ Goal Reached!';
            }
            
            document.getElementById('timerStats').textContent = statsText;
        }

        function updateMetabolicZone(hours) {
            const zone = document.getElementById('metabolicZone');
            
            if (hours < 4) {
                zone.className = 'metabolic-zone zone-anabolic';
                zone.textContent = 'üîµ Anabolic State (0-4h) - Food Digestion';
            } else if (hours < 8) {
                zone.className = 'metabolic-zone zone-catabolic';
                zone.textContent = 'üü† Catabolic State (4-8h) - Glycogen Usage';
            } else if (hours < 12) {
                zone.className = 'metabolic-zone zone-fat-burning';
                zone.textContent = 'üü¢ Fat Burning (8-12h) - Switching to Fat';
            } else if (hours < 16) {
                zone.className = 'metabolic-zone zone-ketosis';
                zone.textContent = 'üü£ Ketosis (12-16h) - Producing Ketones';
            } else if (hours < 24) {
                zone.className = 'metabolic-zone zone-deep-ketosis';
                zone.textContent = 'üî¥ Deep Ketosis (16-24h) - Full Ketone Power';
            } else {
                zone.className = 'metabolic-zone zone-autophagy';
                zone.textContent = 'üîµ Autophagy (24h+) - Cellular Renewal';
            }
        }

        // History & Stats Functions
        async function loadHistory() {
            const userId = currentUser.uid;
            const historySnapshot = await database.ref(`users/${userId}/history`).once('value');
            const history = [];
            
            historySnapshot.forEach(childSnapshot => {
                history.push({ id: childSnapshot.key, ...childSnapshot.val() });
            });
            
            // Sort by start time descending
            history.sort((a, b) => b.startTime - a.startTime);
            
            // Update history table
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">No fasting history yet</td></tr>';
            } else {
                history.forEach(fast => {
                    const row = tbody.insertRow();
                    const date = new Date(fast.startTime).toLocaleDateString();
                    const duration = fast.duration.toFixed(1) + 'h';
                    const goal = fast.goal + 'h';
                    const startWeight = fast.startWeight ? fast.startWeight + ' lbs' : '‚Äî';
                    const endWeight = fast.endWeight ? fast.endWeight + ' lbs' : '‚Äî';
                    const water = fast.water || '‚Äî';
                    const moodEmojis = ['', 'üò´', 'üòê', 'üôÇ', 'üòä', 'üòÑ'];
                    const mood = fast.mood ? moodEmojis[fast.mood] : '‚Äî';
                    const notes = fast.notes || '‚Äî';
                    
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${duration}</td>
                        <td>${goal}</td>
                        <td>${startWeight}</td>
                        <td>${endWeight}</td>
                        <td>${water}</td>
                        <td>${mood}</td>
                        <td>${notes}</td>
                    `;
                });
            }
            
            // Update statistics
            updateStatistics(history);
            updateStreaks(history);
        }

        function updateStatistics(history) {
            if (history.length === 0) {
                document.getElementById('avgDuration').textContent = '‚Äî';
                document.getElementById('totalHours').textContent = '‚Äî';
                document.getElementById('waterAvg').textContent = '‚Äî';
                return;
            }
            
            const totalDuration = history.reduce((sum, fast) => sum + fast.duration, 0);
            const avgDuration = totalDuration / history.length;
            
            // Get average water from daily data
            const userId = currentUser.uid;
            database.ref(`users/${userId}/daily`).once('value').then(snapshot => {
                let totalWater = 0;
                let waterDays = 0;
                
                snapshot.forEach(child => {
                    const data = child.val();
                    if (data.water) {
                        totalWater += data.water;
                        waterDays++;
                    }
                });
                
                const avgWater = waterDays > 0 ? (totalWater / waterDays).toFixed(1) : 0;
                document.getElementById('waterAvg').textContent = avgWater + ' cups';
            });
            
            document.getElementById('avgDuration').textContent = avgDuration.toFixed(1) + 'h';
            document.getElementById('totalHours').textContent = Math.round(totalDuration) + 'h';
        }

        function updateStreaks(history) {
            if (history.length === 0) {
                document.getElementById('currentStreak').textContent = '0';
                document.getElementById('longestStreak').textContent = '0';
                document.getElementById('totalFasts').textContent = '0';
                return;
            }
            
            // Calculate streaks
            const dates = history.map(f => new Date(f.startTime).toDateString()).reverse();
            const uniqueDates = [...new Set(dates)];
            
            let currentStreak = 0;
            let longestStreak = 0;
            let tempStreak = 1;
            
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            // Current streak
            if (uniqueDates[uniqueDates.length - 1] === today || uniqueDates[uniqueDates.length - 1] === yesterday) {
                currentStreak = 1;
                for (let i = uniqueDates.length - 2; i >= 0; i--) {
                    const current = new Date(uniqueDates[i]);
                    const next = new Date(uniqueDates[i + 1]);
                    const diffDays = (next - current) / 86400000;
                    
                    if (diffDays === 1) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
            }
            
            // Longest streak
            for (let i = 1; i < uniqueDates.length; i++) {
                const current = new Date(uniqueDates[i]);
                const prev = new Date(uniqueDates[i - 1]);
                const diffDays = (current - prev) / 86400000;
                
                if (diffDays === 1) {
                    tempStreak++;
                    longestStreak = Math.max(longestStreak, tempStreak);
                } else {
                    tempStreak = 1;
                }
            }
            
            longestStreak = Math.max(longestStreak, tempStreak, currentStreak);
            
            document.getElementById('currentStreak').textContent = currentStreak;
            document.getElementById('longestStreak').textContent = longestStreak;
            document.getElementById('totalFasts').textContent = history.length;
        }

        // Achievements Functions
        async function updateAchievements() {
            const userId = currentUser.uid;
            
            // Get all data needed for achievements
            const historySnapshot = await database.ref(`users/${userId}/history`).once('value');
            const history = [];
            historySnapshot.forEach(child => {
                history.push(child.val());
            });
            
            const profileSnapshot = await database.ref(`users/${userId}/profile`).once('value');
            const profile = profileSnapshot.val() || {};
            
            // Calculate achievement data
            const data = {
                totalFasts: history.length,
                currentStreak: parseInt(document.getElementById('currentStreak').textContent) || 0,
                ketosisCount: history.filter(f => f.duration >= 12).length,
                longest24Plus: history.some(f => f.duration >= 24),
                totalHours: history.reduce((sum, f) => sum + f.duration, 0),
                weightLoss: profile.startWeight ? (profile.startWeight - (profile.weight || profile.startWeight)) : 0,
                fatBurnCount: history.filter(f => f.duration >= 8).length
            };
            
            // Render achievements
            const grid = document.getElementById('achievementsGrid');
            grid.innerHTML = '';
            
            ACHIEVEMENTS.forEach(achievement => {
                const unlocked = achievement.check(data);
                
                const div = document.createElement('div');
                div.className = 'achievement' + (unlocked ? '' : ' locked');
                div.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                `;
                div.title = achievement.desc;
                grid.appendChild(div);
            });
        }

        // Profile Functions
        function showProfileModal() {
            const modal = document.getElementById('profileModal');
            
            // Load current profile data
            const userId = currentUser.uid;
            database.ref(`users/${userId}/profile`).once('value').then(snapshot => {
                const profile = snapshot.val() || {};
                
                document.getElementById('profileWeight').value = profile.weight || '';
                document.getElementById('profileHeight').value = profile.height || '';
                document.getElementById('profileBodyFat').value = profile.bodyFat || '';
                document.getElementById('profileAge').value = profile.age || '';
                document.getElementById('profileGender').value = profile.gender || 'other';
                document.getElementById('profileWaterGoal').value = profile.waterGoal || 8;
            });
            
            modal.classList.add('show');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        async function saveProfile() {
            const userId = currentUser.uid;
            
            const profile = {
                weight: parseFloat(document.getElementById('profileWeight').value) || 0,
                height: parseFloat(document.getElementById('profileHeight').value) || 0,
                bodyFat: parseFloat(document.getElementById('profileBodyFat').value) || 0,
                age: parseInt(document.getElementById('profileAge').value) || 0,
                gender: document.getElementById('profileGender').value,
                waterGoal: parseInt(document.getElementById('profileWaterGoal').value) || 8
            };
            
            await database.ref(`users/${userId}/profile`).update(profile);
            
            // Update displays
            if (profile.weight) {
                document.getElementById('currentWeight').textContent = profile.weight + ' lbs';
            }
            document.getElementById('waterGoal').textContent = profile.waterGoal;
            updateWaterDisplay();
            
            closeProfileModal();
            showToast('üíæ Profile saved!');
        }

        // Export Function
        function exportToExcel() {
            const userId = currentUser.uid;
            database.ref(`users/${userId}/history`).once('value').then(snapshot => {
                const history = [];
                snapshot.forEach(child => {
                    history.push(child.val());
                });
                
                if (history.length === 0) {
                    showToast('No data to export', 'warning');
                    return;
                }
                
                // Create CSV
                let csv = 'Date,Start Time,End Time,Duration (hours),Goal (hours),Start Weight,End Weight,Water (cups),Mood,Notes\n';
                
                history.forEach(fast => {
                    const date = new Date(fast.startTime).toLocaleDateString();
                    const startTime = new Date(fast.startTime).toLocaleTimeString();
                    const endTime = fast.endTime ? new Date(fast.endTime).toLocaleTimeString() : '';
                    const duration = fast.duration.toFixed(2);
                    const goal = fast.goal;
                    const startWeight = fast.startWeight || '';
                    const endWeight = fast.endWeight || '';
                    const water = fast.water || '';
                    const mood = fast.mood || '';
                    const notes = (fast.notes || '').replace(/,/g, ';');
                    
                    csv += `${date},${startTime},${endTime},${duration},${goal},${startWeight},${endWeight},${water},${mood},"${notes}"\n`;
                });
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fasting-history-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                showToast('üì• Exported to Excel!');
            });
        }

        // Utility Functions
        function setSyncBadge(status) {
            const badge = document.getElementById('cloudSyncBadge');
            if (status === 'syncing') {
                badge.className = 'cloud-sync-badge syncing';
                badge.textContent = '‚òÅÔ∏è Syncing...';
            } else {
                badge.className = 'cloud-sync-badge';
                badge.textContent = '‚òÅÔ∏è Synced';
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast' + (type !== 'success' ? ' ' + type : '');
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Auto-save notes
        document.getElementById('notesInput').addEventListener('input', () => {
            if (currentFast) {
                setSyncBadge('syncing');
                clearTimeout(window.notesSaveTimeout);
                window.notesSaveTimeout = setTimeout(saveCurrentFast, 1000);
            }
        });

        // Initialize mood chart on load
        setTimeout(() => {
            if (currentUser) {
                updateMoodChart();
            }
        }, 1000);
    </script>
</body>
</html>
