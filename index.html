<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Fasting Tracker - Integrated</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            color: #667eea;
        }
        
        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        h2 {
            color: #667eea;
            margin: 20px 0 15px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            color: white;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .timer {
            font-size: 4em;
            font-weight: bold;
            text-align: center;
            margin: 30px 0;
            color: #667eea;
            font-variant-numeric: tabular-nums;
        }
        
        .zone-progress {
            margin: 30px 0;
        }
        
        .zone {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .zone.active {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .zone.completed {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .zone.pending {
            background: #f5f5f5;
            color: #999;
        }
        
        .zone-icon {
            font-size: 2em;
            margin-right: 15px;
            min-width: 50px;
            text-align: center;
        }
        
        .zone-info {
            flex: 1;
        }
        
        .zone-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .zone-time {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .zone-description {
            font-size: 0.85em;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            flex: 1;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
            flex: 1;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
        }
        
        .profile-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .profile-item {
            text-align: center;
        }
        
        .profile-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .profile-value {
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .insights {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .insights h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .insight-item {
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .insight-item:last-child {
            border-bottom: none;
        }
        
        .fast-history {
            margin-top: 20px;
        }
        
        .fast-entry {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        
        .fast-entry:hover {
            background: #e9ecef;
        }
        
        .fast-details {
            flex: 1;
        }
        
        .fast-date {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .fast-duration {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .fast-zone {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .zone-badge-anabolic {
            background: #E3F2FD;
            color: #1976D2;
        }
        
        .zone-badge-catabolic {
            background: #FFF3E0;
            color: #F57C00;
        }
        
        .zone-badge-fatburn {
            background: #FFEBEE;
            color: #C62828;
        }
        
        .zone-badge-ketosis {
            background: #F3E5F5;
            color: #7B1FA2;
        }
        
        .zone-badge-deep {
            background: #E8EAF6;
            color: #283593;
        }
        
        .fast-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #667eea;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .no-fast-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .no-fast-state h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: auto;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        @media (max-width: 768px) {
            .timer {
                font-size: 3em;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .fast-entry {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .fast-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab active" onclick="switchTab('current')">üïê Current Fast</button>
            <button class="tab" onclick="switchTab('history')">üìã History</button>
            <button class="tab" onclick="switchTab('stats')">üìä Statistics</button>
            <button class="tab" onclick="switchTab('profile')">üë§ Profile</button>
        </div>
        
        <!-- Current Fast Tab -->
        <div id="tab-current" class="tab-content active">
            <div class="card">
                <div id="no-fast-message" class="no-fast-state" style="display: none;">
                    <h3>No Active Fast</h3>
                    <p>Start a new fast to begin tracking your progress</p>
                    <button class="btn-primary" onclick="startNewFast()" style="margin-top: 20px;">üöÄ Start New Fast</button>
                </div>
                
                <div id="active-fast-content">
                    <h1>üïê Current Fast</h1>
                    <p id="fast-start-info" style="color: #666;">Started: --</p>
                    
                    <div class="profile-info">
                        <h3 style="margin-bottom: 10px;">Your Profile</h3>
                        <div class="profile-grid">
                            <div class="profile-item">
                                <div class="profile-label">Weight</div>
                                <div class="profile-value" id="current-weight">220 lbs</div>
                            </div>
                            <div class="profile-item">
                                <div class="profile-label">Height</div>
                                <div class="profile-value">5'5"</div>
                            </div>
                            <div class="profile-item">
                                <div class="profile-label">Body Fat</div>
                                <div class="profile-value" id="current-bodyfat">37%</div>
                            </div>
                            <div class="profile-item">
                                <div class="profile-label">BMI</div>
                                <div class="profile-value" id="current-bmi">36.6</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timer" id="timer">00:00:00</div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">Hours Fasted</div>
                            <div class="stat-value" id="hours-fasted">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Current Zone</div>
                            <div class="stat-value" id="current-zone" style="font-size: 1.3em;">Anabolic</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Est. Calories Burned</div>
                            <div class="stat-value" id="calories-burned">0</div>
                        </div>
                    </div>
                    
                    <div class="zone-progress">
                        <h2>Metabolic Zones</h2>
                        
                        <div class="zone" id="zone-anabolic">
                            <div class="zone-icon">üçΩÔ∏è</div>
                            <div class="zone-info">
                                <div class="zone-name">Anabolic (Building)</div>
                                <div class="zone-time">0-4 hours</div>
                                <div class="zone-description">Body is digesting and storing energy from your meal</div>
                            </div>
                        </div>
                        
                        <div class="zone" id="zone-catabolic">
                            <div class="zone-icon">‚ö°</div>
                            <div class="zone-info">
                                <div class="zone-name">Catabolic (Breakdown)</div>
                                <div class="zone-time">4-12 hours</div>
                                <div class="zone-description">Glycogen stores being depleted, insulin levels dropping</div>
                            </div>
                        </div>
                        
                        <div class="zone" id="zone-fatburn">
                            <div class="zone-icon">üî•</div>
                            <div class="zone-info">
                                <div class="zone-name">Fat Burning</div>
                                <div class="zone-time">12-16 hours</div>
                                <div class="zone-description">Body shifts to burning fat for fuel, ketone production begins</div>
                            </div>
                        </div>
                        
                        <div class="zone" id="zone-ketosis">
                            <div class="zone-icon">‚öóÔ∏è</div>
                            <div class="zone-info">
                                <div class="zone-name">Ketosis</div>
                                <div class="zone-time">16-24 hours</div>
                                <div class="zone-description">Significant ketone production, enhanced mental clarity</div>
                            </div>
                        </div>
                        
                        <div class="zone" id="zone-deep">
                            <div class="zone-icon">üß¨</div>
                            <div class="zone-info">
                                <div class="zone-name">Deep Ketosis & Autophagy</div>
                                <div class="zone-time">24+ hours</div>
                                <div class="zone-description">Cellular cleanup intensifies, autophagy peaks, HGH increases</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="insights">
                        <h3>üí° Real-Time Insights</h3>
                        <div id="insights-content">
                            <div class="insight-item">
                                <strong>Current Status:</strong> <span id="insight-status">Your body is in the early digestion phase.</span>
                            </div>
                            <div class="insight-item">
                                <strong>With your body composition:</strong> <span id="insight-composition">You have approximately 81 lbs of fat mass available for fuel.</span>
                            </div>
                            <div class="insight-item">
                                <strong>Recommendation:</strong> <span id="insight-recommendation">Stay hydrated.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-secondary" onclick="openNoteModal()">üìù Add Note</button>
                        <button class="btn-primary" onclick="openGoalModal()">üéØ Set Goal</button>
                        <button class="btn-danger" onclick="endFast()">üç¥ End Fast</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="tab-history" class="tab-content">
            <div class="card">
                <h1>üìã Fasting History</h1>
                <p style="color: #666; margin-bottom: 20px;">Complete log of all your fasts</p>
                
                <div class="button-group" style="margin-bottom: 20px;">
                    <button class="btn-primary" onclick="startNewFast()">üöÄ Start New Fast</button>
                    <button class="btn-secondary" onclick="exportToExcel()">üì• Export to Excel</button>
                </div>
                
                <div id="fast-history-list" class="fast-history">
                    <!-- Fast entries will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Statistics Tab -->
        <div id="tab-stats" class="tab-content">
            <div class="card">
                <h1>üìä Statistics & Progress</h1>
                <p style="color: #666; margin-bottom: 20px;">Your fasting journey at a glance</p>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Total Fasts</div>
                        <div class="stat-value" id="stat-total-fasts">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Current Streak</div>
                        <div class="stat-value" id="stat-streak">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Avg Duration</div>
                        <div class="stat-value" id="stat-avg-duration">0h</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Longest Fast</div>
                        <div class="stat-value" id="stat-longest">0h</div>
                    </div>
                </div>
                
                <h2>Weight Progress</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Starting Weight</div>
                        <div class="stat-value" id="stat-start-weight">220</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Current Weight</div>
                        <div class="stat-value" id="stat-current-weight">220</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Lost</div>
                        <div class="stat-value" id="stat-weight-lost">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">BMI Change</div>
                        <div class="stat-value" id="stat-bmi-change">0</div>
                    </div>
                </div>
                
                <h2>Zone Achievements</h2>
                <div class="chart-container">
                    <div>
                        <strong>Fat Burning Zone (12+ hrs):</strong>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fatburn" style="width: 0%">0 times</div>
                        </div>
                    </div>
                    <div>
                        <strong>Ketosis Zone (16+ hrs):</strong>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-ketosis" style="width: 0%">0 times</div>
                        </div>
                    </div>
                    <div>
                        <strong>Deep Ketosis (24+ hrs):</strong>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-deep" style="width: 0%">0 times</div>
                        </div>
                    </div>
                </div>
                
                <h2>Total Hours Fasted</h2>
                <div class="stat-box" style="max-width: 400px;">
                    <div class="stat-label">Lifetime Total</div>
                    <div class="stat-value" id="stat-total-hours">0</div>
                    <div style="margin-top: 10px; font-size: 0.9em;">That's <span id="stat-total-days">0</span> days!</div>
                </div>
            </div>
        </div>
        
        <!-- Profile Tab -->
        <div id="tab-profile" class="tab-content">
            <div class="card">
                <h1>üë§ Profile Settings</h1>
                <p style="color: #666; margin-bottom: 20px;">Update your personal information</p>
                
                <div class="form-group">
                    <label>Weight (lbs)</label>
                    <input type="number" id="profile-weight" value="220" step="0.1">
                </div>
                
                <div class="form-group">
                    <label>Height (inches)</label>
                    <input type="number" id="profile-height" value="65" step="1">
                </div>
                
                <div class="form-group">
                    <label>Body Fat Percentage</label>
                    <input type="number" id="profile-bodyfat" value="37" step="0.1" min="0" max="100">
                </div>
                
                <div class="form-group">
                    <label>Age</label>
                    <input type="number" id="profile-age" value="35" step="1" min="1" max="120">
                </div>
                
                <div class="form-group">
                    <label>Gender</label>
                    <select id="profile-gender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button class="btn-primary" onclick="saveProfile()">üíæ Save Profile</button>
                    <button class="btn-secondary" onclick="resetData()">üîÑ Reset All Data</button>
                </div>
                
                <div id="profile-alert" class="alert"></div>
                
                <h2>About Your Data</h2>
                <div class="insights">
                    <p><strong>Storage:</strong> All your data is stored locally in your browser. Nothing is sent to any server.</p>
                    <p><strong>Privacy:</strong> Your fasting data, weight, and personal information stay on your device.</p>
                    <p><strong>Backup:</strong> Use the "Export to Excel" button to download a backup of all your data.</p>
                    <p><strong>Sync:</strong> Data doesn't sync between devices. Export/import to transfer data.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Note Modal -->
    <div id="note-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Note</h2>
                <button class="modal-close" onclick="closeModal('note-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Note</label>
                <textarea id="note-text" placeholder="How are you feeling? Any observations?"></textarea>
            </div>
            <button class="btn-primary" onclick="saveNote()">Save Note</button>
        </div>
    </div>
    
    <!-- Set Goal Modal -->
    <div id="goal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Set Fasting Goal</h2>
                <button class="modal-close" onclick="closeModal('goal-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Target Duration (hours)</label>
                <input type="number" id="goal-hours" value="16" min="1" max="168">
            </div>
            <div class="insights">
                <p><strong>Common Goals:</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>16 hours - Standard intermittent fasting (16:8)</li>
                    <li>18 hours - Extended fat burning</li>
                    <li>24 hours - OMAD (One Meal A Day)</li>
                    <li>48+ hours - Extended fast (consult healthcare provider)</li>
                </ul>
            </div>
            <button class="btn-primary" onclick="saveGoal()">Set Goal</button>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ===== DATA MANAGEMENT =====
        
        const STORAGE_KEYS = {
            PROFILE: 'fastingTracker_profile',
            CURRENT_FAST: 'fastingTracker_currentFast',
            FAST_HISTORY: 'fastingTracker_history',
            SETTINGS: 'fastingTracker_settings'
        };
        
        // Initialize or load profile
        function getProfile() {
            const defaultProfile = {
                weight: 220,
                height: 65,
                bodyFat: 37,
                age: 35,
                gender: 'male',
                startWeight: 220,
                startDate: new Date().toISOString()
            };
            
            const saved = localStorage.getItem(STORAGE_KEYS.PROFILE);
            return saved ? JSON.parse(saved) : defaultProfile;
        }
        
        function saveProfileToStorage(profile) {
            localStorage.setItem(STORAGE_KEYS.PROFILE, JSON.stringify(profile));
        }
        
        // Current fast management
        function getCurrentFast() {
            const saved = localStorage.getItem(STORAGE_KEYS.CURRENT_FAST);
            return saved ? JSON.parse(saved) : null;
        }
        
        function saveCurrentFast(fast) {
            if (fast) {
                localStorage.setItem(STORAGE_KEYS.CURRENT_FAST, JSON.stringify(fast));
            } else {
                localStorage.removeItem(STORAGE_KEYS.CURRENT_FAST);
            }
        }
        
        // History management
        function getFastHistory() {
            const saved = localStorage.getItem(STORAGE_KEYS.FAST_HISTORY);
            return saved ? JSON.parse(saved) : [];
        }
        
        function saveFastHistory(history) {
            localStorage.setItem(STORAGE_KEYS.FAST_HISTORY, JSON.stringify(history));
        }
        
        function addToHistory(fast) {
            const history = getFastHistory();
            history.unshift(fast); // Add to beginning
            saveFastHistory(history);
        }
        
        // ===== INITIALIZE APP =====
        
        let currentFast = getCurrentFast();
        let profile = getProfile();
        let timerInterval = null;
        let fastGoal = 16; // Default 16 hours
        
        function initializeApp() {
            // Load profile into form
            document.getElementById('profile-weight').value = profile.weight;
            document.getElementById('profile-height').value = profile.height;
            document.getElementById('profile-bodyfat').value = profile.bodyFat;
            document.getElementById('profile-age').value = profile.age;
            document.getElementById('profile-gender').value = profile.gender;
            
            // Update display
            updateProfileDisplay();
            
            // Check if there's an active fast
            if (currentFast) {
                showActiveFast();
                startTimer();
            } else {
                showNoFastState();
            }
            
            // Update history and stats
            updateHistoryDisplay();
            updateStatisticsDisplay();
        }
        
        function showNoFastState() {
            document.getElementById('no-fast-message').style.display = 'block';
            document.getElementById('active-fast-content').style.display = 'none';
        }
        
        function showActiveFast() {
            document.getElementById('no-fast-message').style.display = 'none';
            document.getElementById('active-fast-content').style.display = 'block';
            
            const startDate = new Date(currentFast.startTime);
            document.getElementById('fast-start-info').textContent = 
                `Started: ${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        }
        
        // ===== TAB NAVIGATION =====
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            // Update displays
            if (tabName === 'history') {
                updateHistoryDisplay();
            } else if (tabName === 'stats') {
                updateStatisticsDisplay();
            }
        }
        
        // ===== FASTING OPERATIONS =====
        
        function startNewFast() {
            if (currentFast) {
                if (!confirm('You have an active fast. End it before starting a new one?')) {
                    return;
                }
                endFast(false);
            }
            
            currentFast = {
                id: Date.now(),
                startTime: new Date().toISOString(),
                startWeight: profile.weight,
                notes: [],
                goal: fastGoal
            };
            
            saveCurrentFast(currentFast);
            showActiveFast();
            startTimer();
            switchTab('current');
            
            // Make sure the first tab button is active
            document.querySelectorAll('.tab').forEach((tab, index) => {
                if (index === 0) tab.classList.add('active');
                else tab.classList.remove('active');
            });
        }
        
        function endFast(showConfirm = true) {
            if (!currentFast) return;
            
            const now = new Date();
            const elapsed = now - new Date(currentFast.startTime);
            const hours = (elapsed / (1000 * 60 * 60)).toFixed(1);
            
            if (showConfirm) {
                if (!confirm(`End your fast now?\n\nTotal duration: ${hours} hours`)) {
                    return;
                }
            }
            
            // Complete the fast
            currentFast.endTime = now.toISOString();
            currentFast.duration = parseFloat(hours);
            currentFast.endWeight = profile.weight;
            currentFast.maxZone = getZoneName(currentFast.duration);
            
            // Add to history
            addToHistory(currentFast);
            
            // Clear current fast
            currentFast = null;
            saveCurrentFast(null);
            
            // Stop timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Show completion message
            if (showConfirm) {
                alert(`Fast completed! ${hours} hours\n\nGreat job! Your fast has been saved to history.`);
            }
            
            // Update displays
            showNoFastState();
            updateHistoryDisplay();
            updateStatisticsDisplay();
        }
        
        // ===== TIMER LOGIC =====
        
        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function updateTimer() {
            if (!currentFast) return;
            
            const now = new Date();
            const elapsed = now - new Date(currentFast.startTime);
            
            const hours = Math.floor(elapsed / (1000 * 60 * 60));
            const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
            
            document.getElementById('timer').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            const totalHours = hours + minutes/60;
            document.getElementById('hours-fasted').textContent = hours;
            
            // Update calorie burn
            const bmr = calculateBMR(profile);
            const caloriesBurned = Math.round((bmr / 24) * totalHours);
            document.getElementById('calories-burned').textContent = caloriesBurned;
            
            // Update zones
            updateZones(totalHours);
            
            // Update insights
            updateInsights(totalHours);
        }
        
        function calculateBMR(profile) {
            // Mifflin-St Jeor Equation
            const weightKg = profile.weight / 2.205;
            const heightCm = profile.height * 2.54;
            
            if (profile.gender === 'male') {
                return (10 * weightKg) + (6.25 * heightCm) - (5 * profile.age) + 5;
            } else {
                return (10 * weightKg) + (6.25 * heightCm) - (5 * profile.age) - 161;
            }
        }
        
        function updateZones(totalHours) {
            const zones = [
                { id: 'zone-anabolic', start: 0, end: 4, name: 'Anabolic' },
                { id: 'zone-catabolic', start: 4, end: 12, name: 'Catabolic' },
                { id: 'zone-fatburn', start: 12, end: 16, name: 'Fat Burning' },
                { id: 'zone-ketosis', start: 16, end: 24, name: 'Ketosis' },
                { id: 'zone-deep', start: 24, end: Infinity, name: 'Deep Ketosis' }
            ];
            
            let currentZoneName = 'Anabolic';
            
            zones.forEach(zone => {
                const element = document.getElementById(zone.id);
                element.classList.remove('active', 'completed', 'pending');
                
                if (totalHours >= zone.start && totalHours < zone.end) {
                    element.classList.add('active');
                    currentZoneName = zone.name;
                } else if (totalHours >= zone.end) {
                    element.classList.add('completed');
                } else {
                    element.classList.add('pending');
                }
            });
            
            document.getElementById('current-zone').textContent = currentZoneName;
        }
        
        function getZoneName(hours) {
            if (hours >= 24) return 'Deep Ketosis';
            if (hours >= 16) return 'Ketosis';
            if (hours >= 12) return 'Fat Burning';
            if (hours >= 4) return 'Catabolic';
            return 'Anabolic';
        }
        
        function updateInsights(totalHours) {
            let status = '';
            let recommendation = '';
            
            if (totalHours < 4) {
                status = 'Your body is in the early digestion phase. Insulin is elevated as nutrients are being absorbed.';
                recommendation = 'Stay hydrated with water. Your body is still processing your last meal.';
            } else if (totalHours < 12) {
                status = 'Blood sugar and insulin levels are dropping. Your body is beginning to shift from glucose to stored glycogen.';
                recommendation = 'Light hunger is normal. Black coffee, tea, or sparkling water can help. Gentle movement like walking aids fat mobilization.';
            } else if (totalHours < 16) {
                status = 'Glycogen stores are depleted. Your body is actively burning fat and producing ketones for fuel.';
                recommendation = 'Mental clarity may increase. Consider light exercise. Stay hydrated and supplement electrolytes if needed.';
            } else if (totalHours < 24) {
                status = 'You\'re in ketosis! Ketone bodies are your primary fuel. Autophagy (cellular cleanup) is ramping up.';
                recommendation = 'Peak fat burning zone. Mental focus should be excellent. Monitor energy levels and break fast if feeling weak.';
            } else {
                status = 'Deep ketosis achieved. Autophagy is at its peak. Growth hormone levels significantly elevated.';
                recommendation = 'Impressive! You\'re getting maximum cellular benefits. Consider your goals and energy - extended fasts should be done with care.';
            }
            
            document.getElementById('insight-status').textContent = status;
            document.getElementById('insight-recommendation').textContent = recommendation;
            
            // Body composition insight
            const fatMass = profile.weight * (profile.bodyFat / 100);
            const totalEnergyAvailable = Math.round(fatMass * 3500);
            document.getElementById('insight-composition').textContent = 
                `You have approximately ${Math.round(fatMass)} lbs of fat mass (~${(totalEnergyAvailable/1000).toFixed(0)}k calories) available for fuel. Your body is well-equipped for extended fasting.`;
        }
        
        // ===== PROFILE MANAGEMENT =====
        
        function updateProfileDisplay() {
            const bmi = ((profile.weight / 2.205) / Math.pow(profile.height * 0.0254, 2)).toFixed(1);
            
            document.getElementById('current-weight').textContent = `${profile.weight} lbs`;
            document.getElementById('current-bodyfat').textContent = `${profile.bodyFat}%`;
            document.getElementById('current-bmi').textContent = bmi;
        }
        
        function saveProfile() {
            profile.weight = parseFloat(document.getElementById('profile-weight').value);
            profile.height = parseFloat(document.getElementById('profile-height').value);
            profile.bodyFat = parseFloat(document.getElementById('profile-bodyfat').value);
            profile.age = parseInt(document.getElementById('profile-age').value);
            profile.gender = document.getElementById('profile-gender').value;
            
            saveProfileToStorage(profile);
            updateProfileDisplay();
            
            showAlert('profile-alert', 'Profile saved successfully!', 'success');
        }
        
        function resetData() {
            if (!confirm('Are you sure you want to reset ALL data? This cannot be undone!\n\nThis will delete:\n- All fasting history\n- Current fast\n- Profile settings')) {
                return;
            }
            
            if (!confirm('Really delete everything? Last chance!')) {
                return;
            }
            
            localStorage.clear();
            location.reload();
        }
        
        // ===== HISTORY DISPLAY =====
        
        function updateHistoryDisplay() {
            const history = getFastHistory();
            const container = document.getElementById('fast-history-list');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="no-fast-state"><h3>No Fasts Yet</h3><p>Start your first fast to see it here</p></div>';
                return;
            }
            
            container.innerHTML = history.map((fast, index) => {
                const startDate = new Date(fast.startTime);
                const endDate = new Date(fast.endTime);
                const zoneClass = getZoneClass(fast.maxZone);
                
                return `
                    <div class="fast-entry">
                        <div class="fast-details">
                            <div class="fast-date">
                                ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}
                            </div>
                            <div class="fast-duration">${fast.duration} hours</div>
                            <span class="fast-zone ${zoneClass}">${fast.maxZone}</span>
                            ${fast.startWeight !== fast.endWeight ? 
                                `<div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    ${fast.startWeight} lbs ‚Üí ${fast.endWeight} lbs 
                                    (${(fast.endWeight - fast.startWeight).toFixed(1)} lbs)
                                </div>` : ''}
                            ${fast.notes && fast.notes.length > 0 ? 
                                `<div style="font-size: 0.85em; color: #999; margin-top: 5px;">
                                    üìù ${fast.notes.length} note(s)
                                </div>` : ''}
                        </div>
                        <div class="fast-actions">
                            <button class="btn-secondary btn-small" onclick="viewFastDetails(${index})">üëÅÔ∏è View</button>
                            <button class="btn-danger btn-small" onclick="deleteFast(${index})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getZoneClass(zoneName) {
            const map = {
                'Anabolic': 'zone-badge-anabolic',
                'Catabolic': 'zone-badge-catabolic',
                'Fat Burning': 'zone-badge-fatburn',
                'Ketosis': 'zone-badge-ketosis',
                'Deep Ketosis': 'zone-badge-deep'
            };
            return map[zoneName] || 'zone-badge-anabolic';
        }
        
        function viewFastDetails(index) {
            const history = getFastHistory();
            const fast = history[index];
            
            const startDate = new Date(fast.startTime);
            const endDate = new Date(fast.endTime);
            
            let details = `Fast #${history.length - index}\n\n`;
            details += `Started: ${startDate.toLocaleString()}\n`;
            details += `Ended: ${endDate.toLocaleString()}\n`;
            details += `Duration: ${fast.duration} hours\n`;
            details += `Max Zone: ${fast.maxZone}\n\n`;
            details += `Weight: ${fast.startWeight} ‚Üí ${fast.endWeight} lbs\n`;
            details += `Change: ${(fast.endWeight - fast.startWeight).toFixed(1)} lbs\n`;
            
            if (fast.notes && fast.notes.length > 0) {
                details += `\nNotes:\n${fast.notes.map(n => `- ${n.text} (${new Date(n.time).toLocaleString()})`).join('\n')}`;
            }
            
            alert(details);
        }
        
        function deleteFast(index) {
            if (!confirm('Delete this fast from history?')) return;
            
            const history = getFastHistory();
            history.splice(index, 1);
            saveFastHistory(history);
            updateHistoryDisplay();
            updateStatisticsDisplay();
        }
        
        // ===== STATISTICS DISPLAY =====
        
        function updateStatisticsDisplay() {
            const history = getFastHistory();
            
            if (history.length === 0) {
                document.getElementById('stat-total-fasts').textContent = '0';
                document.getElementById('stat-streak').textContent = '0';
                document.getElementById('stat-avg-duration').textContent = '0h';
                document.getElementById('stat-longest').textContent = '0h';
                document.getElementById('stat-total-hours').textContent = '0';
                document.getElementById('stat-total-days').textContent = '0';
                return;
            }
            
            // Basic stats
            document.getElementById('stat-total-fasts').textContent = history.length;
            
            // Calculate streak (consecutive days with fasts)
            let streak = 1;
            const today = new Date().toDateString();
            for (let i = 0; i < history.length - 1; i++) {
                const currentDate = new Date(history[i].endTime).toDateString();
                const nextDate = new Date(history[i + 1].endTime).toDateString();
                
                const daysDiff = Math.floor((new Date(currentDate) - new Date(nextDate)) / (1000 * 60 * 60 * 24));
                if (daysDiff <= 1) {
                    streak++;
                } else {
                    break;
                }
            }
            document.getElementById('stat-streak').textContent = streak;
            
            // Average duration
            const totalHours = history.reduce((sum, fast) => sum + fast.duration, 0);
            const avgDuration = (totalHours / history.length).toFixed(1);
            document.getElementById('stat-avg-duration').textContent = `${avgDuration}h`;
            
            // Longest fast
            const longest = Math.max(...history.map(f => f.duration));
            document.getElementById('stat-longest').textContent = `${longest.toFixed(1)}h`;
            
            // Total hours
            document.getElementById('stat-total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('stat-total-days').textContent = (totalHours / 24).toFixed(1);
            
            // Weight stats
            document.getElementById('stat-start-weight').textContent = `${profile.startWeight} lbs`;
            document.getElementById('stat-current-weight').textContent = `${profile.weight} lbs`;
            document.getElementById('stat-weight-lost').textContent = `${(profile.startWeight - profile.weight).toFixed(1)} lbs`;
            
            const startBMI = ((profile.startWeight / 2.205) / Math.pow(profile.height * 0.0254, 2));
            const currentBMI = ((profile.weight / 2.205) / Math.pow(profile.height * 0.0254, 2));
            document.getElementById('stat-bmi-change').textContent = (currentBMI - startBMI).toFixed(1);
            
            // Zone achievements
            const fatBurnCount = history.filter(f => f.duration >= 12).length;
            const ketosisCount = history.filter(f => f.duration >= 16).length;
            const deepCount = history.filter(f => f.duration >= 24).length;
            
            const maxCount = Math.max(fatBurnCount, ketosisCount, deepCount, 1);
            
            document.getElementById('progress-fatburn').style.width = `${(fatBurnCount / maxCount) * 100}%`;
            document.getElementById('progress-fatburn').textContent = `${fatBurnCount} times`;
            
            document.getElementById('progress-ketosis').style.width = `${(ketosisCount / maxCount) * 100}%`;
            document.getElementById('progress-ketosis').textContent = `${ketosisCount} times`;
            
            document.getElementById('progress-deep').style.width = `${(deepCount / maxCount) * 100}%`;
            document.getElementById('progress-deep').textContent = `${deepCount} times`;
        }
        
        // ===== MODALS =====
        
        function openNoteModal() {
            document.getElementById('note-text').value = '';
            document.getElementById('note-modal').classList.add('show');
        }
        
        function openGoalModal() {
            document.getElementById('goal-hours').value = fastGoal;
            document.getElementById('goal-modal').classList.add('show');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        function saveNote() {
            const noteText = document.getElementById('note-text').value.trim();
            if (!noteText || !currentFast) return;
            
            if (!currentFast.notes) currentFast.notes = [];
            currentFast.notes.push({
                text: noteText,
                time: new Date().toISOString()
            });
            
            saveCurrentFast(currentFast);
            closeModal('note-modal');
            alert('Note saved!');
        }
        
        function saveGoal() {
            fastGoal = parseInt(document.getElementById('goal-hours').value);
            if (currentFast) {
                currentFast.goal = fastGoal;
                saveCurrentFast(currentFast);
            }
            closeModal('goal-modal');
            alert(`Goal set to ${fastGoal} hours!`);
        }
        
        // ===== EXCEL EXPORT =====
        
        function exportToExcel() {
            const history = getFastHistory();
            
            if (history.length === 0) {
                alert('No fasting data to export yet!');
                return;
            }
            
            // Prepare data for Excel
            const fastData = history.map((fast, index) => ({
                'Fast #': history.length - index,
                'Start Date': new Date(fast.startTime).toLocaleDateString(),
                'Start Time': new Date(fast.startTime).toLocaleTimeString(),
                'End Date': new Date(fast.endTime).toLocaleDateString(),
                'End Time': new Date(fast.endTime).toLocaleTimeString(),
                'Duration (hrs)': fast.duration,
                'Max Zone': fast.maxZone,
                'Start Weight': fast.startWeight,
                'End Weight': fast.endWeight,
                'Weight Change': (fast.endWeight - fast.startWeight).toFixed(1),
                'Notes': fast.notes ? fast.notes.map(n => n.text).join('; ') : ''
            }));
            
            // Statistics sheet
            const stats = [
                ['Statistic', 'Value'],
                ['Total Fasts', history.length],
                ['Average Duration (hrs)', (history.reduce((s, f) => s + f.duration, 0) / history.length).toFixed(1)],
                ['Longest Fast (hrs)', Math.max(...history.map(f => f.duration)).toFixed(1)],
                ['Total Hours Fasted', history.reduce((s, f) => s + f.duration, 0).toFixed(1)],
                ['Starting Weight', profile.startWeight],
                ['Current Weight', profile.weight],
                ['Weight Lost', (profile.startWeight - profile.weight).toFixed(1)],
                ['Times in Fat Burning (12+ hrs)', history.filter(f => f.duration >= 12).length],
                ['Times in Ketosis (16+ hrs)', history.filter(f => f.duration >= 16).length],
                ['Times in Deep Ketosis (24+ hrs)', history.filter(f => f.duration >= 24).length]
            ];
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Add Fast Log sheet
            const ws1 = XLSX.utils.json_to_sheet(fastData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Fast Log');
            
            // Add Statistics sheet
            const ws2 = XLSX.utils.aoa_to_sheet(stats);
            XLSX.utils.book_append_sheet(wb, ws2, 'Statistics');
            
            // Add Profile sheet
            const profileData = [
                ['Profile Information', ''],
                ['Weight', `${profile.weight} lbs`],
                ['Height', `${Math.floor(profile.height / 12)}'${profile.height % 12}"`],
                ['Body Fat', `${profile.bodyFat}%`],
                ['Age', profile.age],
                ['Gender', profile.gender],
                ['BMI', ((profile.weight / 2.205) / Math.pow(profile.height * 0.0254, 2)).toFixed(1)],
                ['Fat Mass', `${(profile.weight * profile.bodyFat / 100).toFixed(1)} lbs`],
                ['Lean Mass', `${(profile.weight * (1 - profile.bodyFat / 100)).toFixed(1)} lbs`]
            ];
            const ws3 = XLSX.utils.aoa_to_sheet(profileData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Profile');
            
            // Generate filename with date
            const filename = `Fasting_Tracker_Export_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            // Save file
            XLSX.writeFile(wb, filename);
            
            alert(`Excel file exported successfully!\n\nFilename: ${filename}`);
        }
        
        // ===== UTILITY FUNCTIONS =====
        
        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.textContent = message;
            alert.className = `alert alert-${type} show`;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }
        
        // ===== INITIALIZE ON LOAD =====
        
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Save current fast periodically (every 5 minutes) in case of browser crash
        setInterval(() => {
            if (currentFast) {
                saveCurrentFast(currentFast);
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>